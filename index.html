<!doctype html>
  <html>

<head>
    <meta charset="utf-8">
    <title>Compiler Dependency Tutor</title>
    <meta name="description" content="Input code analysis, dependence visualization, dependence tests">
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <!-- FONTS -->
<link href="https://fonts.googleapis.com/css?family=Arvo:400,400i,700,700i" rel="stylesheet">
    
<!-- USER INPUT -->
<link rel="stylesheet" href="css/codemirror.css">
<link rel="stylesheet" href="webfont.css">
<link type="text/css" rel="stylesheet" href="css/jquery.qtip.min.css" />

<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="js/jquery.qtip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
<script src="js/codemirror.js"></script>
<script src="js/collections.min.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      CommonHTML: {
        scale: 120
      }
    });
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML"></script>
    
<!-- DEPENDENCY ANALYSIS -->
<script src="js/bundle.js"></script>
<!-- GRAPH RENDERING -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css">

<!-- CHROMA -->
<!---<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>-->
  <style type="text/css">
    #is_network {
        width: 100%;
        height: 532px;
        /*border: 2px solid lightgray;*/
        display:inline-block;
        /*margin:10px 0px 10px 0;*/
    }
    #dg_network {
        width: 100%;
        height: 350px;
        /*border: 2px solid lightgray;*/
        display:inline-block;
        /*margin:10px 0px 10px 0;*/
    }
</style>
</head>

<body>

<div id="header">
    <div id="header_left">
        <div id="title">Compiler Dependency Tutor</div>
        <div id="desc">Input code analysis, dependence visualization, dependence tests</div>
    </div>
    <div id="header_right">
        <ul>
            <li><a href="#ex1" rel="modal:open">Getting Started</a></li>
        </ul>
    </div>
</div>

<div id ="holder3_refresh" style="display:none;"><button id="holder3_actual_refresh" class="refresh"><span class="refresh_icon">Z</span></button></div>	
<div id="wrapper">
<div id="leftside">
<div id="editor">
    <div id="code"></div>
    <div class="under_code">
    <button id="parse_button" class="my_button"><span class="my_button_icon">~</span><span class="my_button_text">Parse</span></button>
    <nav id="primary_nav_wrap">
            <ul>
              <li><a href="#"><span class="my_button_icon">&#xe020;</span> Load test</a>
                <ul>
                <li><a href="#">Subscript Tests</a>
                    <ul>
                        <li><a href="#">ZIV</a>
                            <ul>
                                <li><a href="#" onclick="load_test(12); return false;">1</a></li>
                                <li><a href="#" onclick="load_test(13); return false;">2</a></li>
                            </ul>
                        </li>
                        <li><a href="#">SIV</a>
                            <ul>
                                <li><a href="#">Strong SIV</a>
                                    <ul>
                                        <li><a href="#" onclick="load_test(14); return false;">1</a></li>
                                        <li><a href="#" onclick="load_test(15); return false;">2</a></li>
                                        <li><a href="#" onclick="load_test(16); return false;">3</a></li>
                                    </ul>
                                </li>
                                <li><a href="#">Weak SIV</a>
                                    <ul>
                                        <li><a href="#" onclick="load_test(21); return false;">1</a></li>
                                        <li><a href="#" onclick="load_test(22); return false;">2</a></li>
                                        <li><a href="#" onclick="load_test(23); return false;">3</a></li>
                                    </ul>
                                </li>
                                <li><a href="#">Weak-Zero SIV</a>
                                    <ul>
                                        <li><a href="#" onclick="load_test(17); return false;">1</a></li>
                                        <li><a href="#" onclick="load_test(18); return false;">2</a></li>
                                    </ul>
                                </li>
                                <li><a href="#">Weak-Crossing SIV</a>
                                    <ul>
                                        <li><a href="#" onclick="load_test(19); return false;">1</a></li>
                                        <li><a href="#" onclick="load_test(20); return false;">2</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><a href="#">MIV</a>
                            <ul>
                                <li><a href="#" onclick="load_test(24); return false;">1</a></li>
                                <li><a href="#" onclick="load_test(25); return false;">2</a></li>
                            </ul>
                        </li>
                        <li><a href="#">COUPLED</a>
                            <ul>
                                <li><a href="#" onclick="load_test(26); return false;">1</a></li>
                                <li><a href="#" onclick="load_test(27); return false;">2</a></li>
                            </ul>
                        </li>
                    </ul>
                  </li>
                  <li><a href="#">Dependency Graph</a>
                    <ul>
                      <li><a href="#" onclick="load_test(8); return false;">Two Statements</a></li>
                      <li><a href="#" onclick="load_test(9); return false;">Slide</a></li>
                      <li><a href="#" onclick="load_test(10); return false;">3</a></li>
                      <li><a href="#" onclick="load_test(11); return false;">4</a></li>
                    </ul>
                  </li>
                  <li><a href="#">Iteration Space</a>
                    <ul>
                      <li><a href="#" onclick="load_test(4); return false;">-1,-1</a></li>
                      <li><a href="#" onclick="load_test(5); return false;">One point</a></li>
                      <li><a href="#" onclick="load_test(6); return false;">A(I,J) = A(J,I)</a></li>
                      <li><a href="#" onclick="load_test(7); return false;">Multiple statements</a></li>
                    </ul>
                  </li>
                  <li><a href="#">Basic</a>
                    <ul>
                      <li><a href="#" onclick="load_test(1); return false;">RAW</a></li>
                      <li><a href="#" onclick="load_test(2); return false;">WAR</a></li>
                      <li><a href="#" onclick="load_test(3); return false;">WAW</a></li>
                    </ul>
                  </li>
                
                </ul>
              </li>
            </ul>
            </nav>
            </div>
        
</div>
<div id="visualizer">
    <div id ="question_vis"><div class ="question">&#xe03a;</div><div id ="question_down">Labels</div></div>
    <div id="tooltip_vis">
            <div class="other">Toggle on/off for simulation and select for dependence tests.
                    <div class="other2">                 
                    <div style="display:block; margin-bottom:5px; margin-top:12px;"><div style="display:inline-block; margin-left:50px;">Off</div><div style="display:inline-block; margin-left:43px">On</div><div style="display:inline-block; margin-left:47px">Selected</div></div>
                    <div style="display:block; margin-bottom:5px;"><div style="display:inline-block; text-align:right; width:39px; ">Stmt</div><div class="stmt" style="display:inline-block; margin-left:10px; font-size:14px">S1</div><div class="stmt" style="display:inline-block; background-color:#666; margin-left:40px; font-size:14px">S1</div><div style="display:inline-block; margin-left:38px">none</div></div>
                    <div style="display:block; margin-bottom:5px;"><div style="display:inline-block; text-align:right; width:39px;">Write</div><div class="vwrite" style="display:inline-block; margin-left:10px; font-size:14px">A(I)</div><div class="vwrite" style="display:inline-block; background-color:blue; margin-left:5px; font-size:14px;">A(I)</div><div class="vwrite" style="display:inline-block; background-color:orange; margin-left:5px; font-size:14px;">A(I)</div></div>      
                    <div style="display:block; margin-bottom:12px;"><div style="display:inline-block; text-align:right; width:39px;">Read</div><div class="vread" style="display:inline-block; margin-left:10px; font-size:14px">A(I)</div><div class="vread" style="display:inline-block; background-color:red; margin-left:5px; font-size:14px;">A(I)</div><div class="vwrite" style="display:inline-block; background-color:orange; margin-left:5px; font-size:14px;">A(I)</div></div>                     
                    </div>              
            They are all toggled <b>ON</b> by default and selection is available when analyzing subscripts.
            </div>
    </div>
    <div id="root"></div>
    <div class="under_code_vis" id="vis_under">
    <button id="edit_button" class="my_button"><span class="my_button_icon">*</span><span class="my_button_text">Edit</span></button>
    <button id="run_button" class="my_button"><span class="my_button_icon">K</span><span class="my_button_text">Run</span><span class="on_demand">on demand</span></button>
    <div id="toggle_thing">
    <span class="toggle_text">or</span>
    <label class="switch">
            <input id="auto_run" type="checkbox" checked>
            <span class="slider round"></span>
    </label>
    <span class="toggle_text">Run automatically</span></div>
    </div>
</div>
<div id ="console" style="overflow-y: scroll; height:200px;"></div>
</div>
    
<div id="printer">
    <!--
    <div id="options_bar">
        <button id="is_button" class="button_tab">Iteration Space</button>
        <button id="dg_button" class="button_tab">Dependency Graph</button>
        <button id="gcd_button" class="button_tab">GCD Test</button>
    </div>
    <div id="mynetwork"></div>-->
    <div class="tab">
        <button id="itspc_button" class="tablinks" onclick="openTab(event, 'IterationSpace')"><div class="tab_icon">&#xe05a;</div> Iteration Space</button>
        <button class="tablinks" onclick="openTab(event, 'DependencyGraph')"><div class="tab_icon">&#xe03e;</div> Dependency Graph</button>
        <button class="tablinks" onclick="openTab(event, 'SubscriptTests')"><div class="tab_icon">R</div> Subscript Tests</button>
    </div>
    <div id="IterationSpace" class="tabcontent">
        <div id="is_network"></div>
        <div id="is_bottom">
                <div id="labels">
                        <div id="labels_itspc">
                            <div style="display:inline-block; margin-right:10px; font-weight:bold;">Dependencies:</div>
                            <div style="width:20px; height:20px; background-color:#FF7C23; display: inline-block;"></div><div style="display:inline-block; margin-left:5px;">RAW</div>
                            <div style="margin-left:15px; width:20px; height:20px; background-color:#5889FF; display: inline-block;"></div><div style="display:inline-block; margin-left:5px;">WAR</div>
                            <div style="margin-left:15px; width:20px; height:20px; background-color:red; display: inline-block;"></div><div style="display:inline-block; margin-left:5px;">WAW</div>
                            <div style="margin-left:15px; width:20px; height:20px; background-color:#B660E8; display: inline-block;"></div><div style="display:inline-block; margin-left:5px;">Mixed</div>
                        </div>
                    </div>
			<div style="margin:15px 20px 0 20px; color:orange; font-weight:bold;">Note: these are iteration vectors (see below), not array calls/references!</div>
        <div style="margin:40px 20px 20px 20px;">
		<h3>Dependence</h3>
        <div>There are 3 types of data dependence; consider, in a piece of code, two statements S<sub>1</sub> and S<sub>2</sub> that execute in order:</div>
        <div style="display:inline-block; width:150px; font-size:18px; ">
                <h4>Flow (True) RAW hazard</h4>
                <p>S<sub>1</sub> a  = ..</p>
                <p>S<sub>2</sub> .. = a</p>
                <p></p>
                <p>Denoted S<sub>2</sub> δ S<sub>1</sub></p>
            </div>
        <div style="display:inline-block; margin-left:15px; width:150px; font-size:18px;">
                <h4>Anti WAR hazard</h4>
                <p>S<sub>1</sub> ..  = a</p>
                <p>S<sub>2</sub> a = ..</p>
                <p></p>
                <p>Denoted S<sub>2</sub> δ<sup>-1</sup> S<sub>1</sub></p>
            </div>            
        <div style="display:inline-block; margin-left:15px; width:150px; font-size:18px; ">
                <h4>Output WAW hazard</h4>
                <p>S<sub>1</sub> a = ..</p>
                <p>S<sub>2</sub> a = ..</p>
                <p></p>
                <p>Denoted S2 δ<sup>0</sup> S<sub>1</sub></p>
            </div>            
        <div>Only data flow dependences are true dependences. Anti and output can be removed by renaming.</div>
		<br>
		<h3>
			Iteration Space
			</h3>
			<div>
				Now that we have formalized dependence between two singular statements, let's look at it in terms of a loop or a block of nested loops that iterate over statements.
			</div>
			<p>
				
			</p>
        <div>Each iteration in a loop has a <b>iteration number</b> which is the value of the loop index at that iteration.</div>
        <p><b>Iteration vector</b> I of iteration is the vector of integers containing numbers for loops in order of nesting level.</p>
        <div style="font-family:'Courier New', Courier, monospace">
        <div style="margin-left:20px;">DO I=1,4</div>
        <div style="margin-left:40px;">DO J=1,6</div>
        <div style="margin-left:60px;">STATEMENT</div>
        <div style="margin-left:40px;">ENDDO</div>
        <div style="margin-left:20px;">ENDDO</div>
        <p></p></div>
        <div>Iteration vector (2,1) of S is when I = 2 and J = 1.
        <br>The iteration vectors are ordered by execution order.
		<p>
			
			<img src="img/itspc.png" width=35% display:block;"></p>
		Our iteration space is the set of all iteration vectors in order of execution given a loop or a nested loop, where the nodes are the iteration vectors and the directed edges showcase dependence of an interation on another. If there is an edge from an iteration I to an interation J, that means that there is a statement in iteration J that depends on a statement in iteration I. There is also a distance between the iterations on the edge, which might be helpful to know in order to concretize the dependence and find a direction of the dependence in our loop.
		<br><br>Depending on the iteration in which two statements are executed, we can two types of loop-based dependencies:
            <p></p>
            <p></p>
                <b>Loop-independent dependency</b>
                <br>If statement S<sub>2</sub> depends on S<sub>1</sub> and S<sub>1</sub>,S<sub>2</sub> execute in the same iteration. Distance (0,0,..) and Direction (=,=,..).
                <p></p><b>Loop-carried dependency</b>
                <br>If statement S<sub>2</sub> depends on S<sub>1</sub> and S<sub>1</sub>,S<sub>2</sub> execute in different iterations.
                <br><br>
			<h3>
				Distance and Direction
			</h3>
                <b>Dependence distance</b>
                <br>If dependence is between iteration I<sub>write</sub> and I<sub>read</sub>, then distance is I<sub>read</sub> - I<sub>write</sub>.
                <br>Example: Write A(10,11) at iteration (5,5). Read A(10,11) at iteration (5,6). Distance is (0,1).
        </div>
        <div>
            <p>If dependence distances all same, then say loop has that dependence distance. But, loop may have many different dependence distances.</p>
            <p>Direction vector summarises directions. If first non = element is &lt then indicates flow dependence.</p>
            <ul style="font-size:20px;">
                <li>&lt - All +ve</li>
                <li>&gt - All -ve</li>
                <li>= - All 0</li>
                <li>* - Mixed</li>
            </ul>
            <p>For example, given distances:</p>
            <ul>
                <li>(0, 1, -1, -1)</li>
                <li>(0, 2, -2, 0)</li>
                <li>(0, 3, -3, 1)</li>
            </ul>
            <p>Direction is:</p>
            <ul>
                <li>(=, &lt, &gt, *)</li>
            </ul>
        </div>
        <p>You can also check the Compiler Optimization course slides on the Iteration Space topic <a target="_blank" rel="noopener noreferrer" href="https://www.inf.ed.ac.uk/teaching/courses/copt/lecture-8.pdf">here</a>.</p>
        </div>
    </div>
    </div>
    <div id="DependencyGraph" class="tabcontent">
        <div id="dg_network"></div>
        <div id="dg_bottom">
            <div id="labels">
                <div id="labels_dpgph">
                        <div style="display:inline-block; margin-right:10px; font-weight:bold;">Dependencies:</div>
                        <div style="display: inline-block;"><span style="font-size:24px;">δ</span></div><div style="display:inline-block; margin-left:5px;">RAW</div>
                        <div style="margin-left:15px; display: inline-block;"><span style="font-size:24px;">δ⁻¹</span></div><div style="display:inline-block; margin-left:5px;">WAR</div>
                        <div style="margin-left:15px; display: inline-block;"><span style="font-size:24px;">δ⁰</span></div><div style="display:inline-block; margin-left:5px;">WAW</div>
                        <div style="margin-left:15px; display: inline-block;"><span style="font-size:24px;">δᵢ</span></div><div style="display:inline-block; margin-left:8px;">subscript <i><b>i</b></i> denotes level of loop carried dependence</div>
                    </div>
            </div>
    </div>
    <div style="margin:15px 20px 0 20px; color:orange; font-weight:bold;">You can click on or move the statements around to better see the notation!</div>
    <div>
        <div style="margin:40px 20px 20px 20px;">
												<h3>Dependency Graph</h3>
		<p>Rather than looking at the problem in terms of iterations, we can consider statements individually: on what other statements they depend and specify the type and the level of loop carried dependence. We can visualize the dependence in this delta graph regardless of the number of loop levels as we are not limited at 2. Here the nodes are the statements and the edges are the delta-notation of the dependencies.<p>
        <p><b>Level of loop carried dependence</b>
        <br>Level of loop carried dependence is the index of the left-most non = in direction vector. Written as subscript, e.g. <ul> <li>δ<sub>1</sub> for (&lt, =, =)</li> <li>δ<sup>-1</sup><sub>3</sub> for (=, =, >)</li> <li>Infinity for in same loop, e.g. δ∞ for (=, =, =)</li></ul>
        </p>
        <p>Consider the following example:</p>
        <div style="font-family:'Courier New', Courier, monospace";>
        <div style="margin-left:20px;">DO I=1,5</div>
        <div style="margin-left:40px;">DO J=1,5</div>
        <div style="margin-left:60px;">A(I,J-1)=A(I,J)</div>
        <div style="margin-left:60px;">A(I,J)=A(I-1,J-1)</div>
        <div style="margin-left:40px;">ENDDO</div>
        <div style="margin-left:20px;">ENDDO</div>
        </div>
        <p>Loop-carried:</p>
        <ul>
        <li>A(I,J-1) and A(I,J) in S<sub>1</sub> could have created a WAR dependence of distance (0,-1) and direction (=,&gt) => δ<sup>-1</sup><sub>2</sub>, but A(I,J) is overwritten in S<sub>2</sub> - we don't include this in our dependence graph.</li>
        <li>A(I,J-1) from S<sub>1</sub> and A(I,J) from S<sub>2</sub> create a WAW dependence of distance (0,1) and direction (=,&lt) => δ<sup>0</sup><sub>2</sub> </li>
        <li>A(I,J-1) from S<sub>1</sub> and A(I-1,J-1) from S<sub>2</sub> create a RAW dependence of distance (1,0) and direction (&lt,0) => δ<sub>1</sub> </li>
        <li>A(I,J) and A(I-1,J-1) from S<sub>2</sub> create a RAW dependence of distance (1,1) and direction (&lt,&lt) => δ<sub>1</sub></li></ul>
        <p>Loop-independent:</p>
        <ul>
        <li>A(I,J) from both statements create a WAW of distance (0,0) and direction (=,=) => δ<sup>0</sup>∞</li>
        </ul>
        <p>The resulting dependence graph is this:</p>
        <img width="30%" src="img/dep_graph.png">
        <p></p>
        <p>You can also check the Compiler Optimization course slides on the Dependence Graph topic <a target="_blank" rel="noopener noreferrer" href="https://www.inf.ed.ac.uk/teaching/courses/copt/lecture-10.pdf">here</a>.</p>
        </div>
    </div>

    </div>
    <div id="SubscriptTests" class="tabcontent">
        <div class = "nongraph">
        <div class="holder" id="holder1"><div class="step_desc" id="vis_select" style="color:blue;">Array calls:</div><div id ="arrs"></div></div>
        <div class="holder" id="holder2"><div class="step_desc" id="vis_subscr" style="color:blue;">Subscripts:</div><div id="subscripts"></div></div>
        <div class="holder" id="holder3"><div class="step_desc" id="vis_part" style="color:blue;">Partitions:</div><div id="partitions"></div></div>
        <div class = "st_step" id ="st_step_select">
			<div style="margin-bottom:15px; font-size:17px; line-height:25px;">This is quite different from iteration space and dependence graph sections. You get to capture subscripts, and analyze them step by step-first determing their type and then applying the corresponding test. You get the chance to think for yourself before advancing to the next step. Subscript tests are used to prove independence statically by analyzing the array calls, rather than exaustively building an interation space, which is more so for didactical purposes and inefficient in practice.</div>
            <div id ="st_text_select" class="st_text" style="margin-top:0px;">Select 2 array calls for which to analyze dependence.</div>
            <div style="margin-bottom:15px; font-size:17px; line-height:25px;">For the purpose of these subscript tests, select either: <ul><li><span style="font-weight: 700; color:blue">2 writes</span>  (either which can potentially write to both),</li><li><span style="font-weight: 700; color:blue">1 write</span> (which can write after read) and <span style="font-weight: 700; color:red">1 read</span> (which can read after write).</li></ul>Reading alone does not cause dependence, and analyzing more than 2 array calls is not possible. Note: even if a subscript test presented in this section yields independence, there could still be a write after write dependence of an array call on itself.</div>
            <button id="st_select" class="st_button" style="margin-top:0px;"><span class="my_button_icon">&#xe043;</span>Continue</button>
        </div>
        <div class = "st_step" style="display:none;" id ="st_step_subscr">
            <div id = "st_text_subscr" class="st_text">Transform the array calls selected into subscripts.</div>
            <div style="margin-bottom:10px; font-size:17px; line-height:25px;">The term subscript will be used to refer to one of the subscripted positions in a pair of array references. Since dependence tests always consider a pair of array references, we will always use the term subscript to refer to a pair of subscript positions. For example, in the pair of references to array A in the following loop nest, <div style="font-family:\'Courier New\', Courier, monospace; font-size:20px; color:darkslategrey;"><div style="margin-left:10px; margin-top:15px;">DO i</div><div style="margin-left:20px;">    DO j</div><div style="margin-left:30px;">     DO k</div><div style="margin-left:40px;">      A(i, j) = A(i, k) + C</div><div style="margin-left:30px;">       ENDDO</div><div style="margin-left:20px;">  ENDDO</div><div style="margin-left:10px; margin-bottom:15px;">ENDDO</div></div>index i occurs in the first subscript and indexes j and k occur in the second subscript.</div>
            <button id="st_subscr" class="st_button"><span class="my_button_icon">&#xe043;</span>Get Subscripts</button><button class="refresh"><span class="refresh_icon">Z</span></button>
        </div>
        <div class = "st_step" style="display:none;" id = "st_step_part">
            <div id ="st_text_part" class="st_text">Partition the subscripts previously generated.</div>
            <div style="margin-bottom:10px; font-size:17px; line-height:25px;">Separability describes whether a given subscript interacts with other subscripts for the purpose of dependence testing. When testing multidimensional arrays, a subscript position is said to be separable if its indexes do not occur in the other subscripts. If two different subscripts contain the same index, they are coupled. For example, in the loop below,<div style="font-family:\'Courier New\', Courier, monospace; font-size:20px; color:darkslategrey;"><div style="margin-left:10px; margin-top:15px;">DO i</div><div style="margin-left:20px;">    DO j</div><div style="margin-left:30px;">        DO k</div><div style="margin-left:40px;">            A(i, j, j) = A(i, j, k) + C</div><div style="margin-left:30px;">        ENDDO</div><div style="margin-left:20px;">    ENDDO</div><div style="margin-left:10px; margin-bottom:15px;">ENDDO</div></div>the first subscript is separable, but the second and third are coupled because they both contain j. Partitition the subscripts corresponding to the array calls based on their separability.</div>
            <button id="st_part" class="st_button"><span class="my_button_icon">&#xe043;</span>Get Partitions</button><button class="refresh"><span class="refresh_icon">Z</span></button>
        </div>
        <div id = "parttabs" style="display:none;"></div>
        </div>

        <!---->
<!--
<div id ="tool_subscr" style="font-size:14px; display:none;"><div>The term subscript will be used to refer to one of the subscripted positions in a pair of array references. Since dependence tests always consider a pair of array references, we will always use the term subscript to refer to a pair of subscript positions. For example, in the pair of references to array A in the following loop nest,</div>
<div style="font-family:'Courier New', Courier, monospace;">
<div style="margin-left:10px; margin-top:10px;">DO i</div>
<div style="margin-left:20px;">    DO j</div>
<div style="margin-left:30px;">     DO k</div>
<div style="margin-left:40px;">      A(i, j) = A(i, k) + C</div>
<div style="margin-left:30px;">       ENDDO</div>
<div style="margin-left:20px;">  ENDDO</div>
<div style="margin-left:10px; margin-bottom:10px;">ENDDO</div>
</div>
<div>index i occurs in the first subscript and indexes j and k occur in the second subscript.</div></div>

<div id ="tool_part" style="font-size:14px; display:none;"><div>Separability describes whether a given subscript interacts with other subscripts for the purpose of dependence testing. When testing multidimensional arrays, a subscript position is said to be separable if its indexes do not occur in the other subscripts. If two different subscripts contain the same index, they are coupled. For example, in the loop below,</div>
<div style="font-family:'Courier New', Courier, monospace;">
<div style="margin-left:10px; margin-top:10px;">DO i</div>
<div style="margin-left:20px;">    DO j</div>
<div style="margin-left:30px;">        DO k</div>
<div style="margin-left:40px;">            A(i, j, j) = A(i, j, k) + C</div>
<div style="margin-left:30px;">        ENDDO</div>
<div style="margin-left:20px;">    ENDDO</div>
<div style="margin-left:10px; margin-bottom:10px;">ENDDO</div>
</div>
<div>the first subscript is separable, but the second and third are coupled because they both contain the index j. ZIV subscripts are vacuously separable because they contain no loop indexes. Partitition the subscripts corresponding to the array calls based on their separability.</div>
</div>

<div id="tool_ziv" style="font-size:14px; display:none;">A subscript is said to be ZIV (zero index variable) if the subscript position contains no index in either reference.</div>
<div id="tool_siv" style="font-size:14px; display:none;">A subscript is said to be SIV (single index variable) if only one index occurs in that position.</div>
<div id="tool_miv" style="font-size:14px; display:none;">Any subscript with more than one index is said to be MIV (multiple index variable).</div>
<div id="tool_coupled" style="font-size:14px; display:none;">If two different subscripts contain the same index, they are coupled.</div>
<div id="tool_ivinfo" style="font-size:14px; display:none;"><div>For instance, consider the following loop:</div>
<div style="font-family:'Courier New', Courier, monospace;">
<div style="margin-left:10px; margin-top:10px;">DO i</div>
<div style="margin-left:20px;">    DO j</div>
<div style="margin-left:30px;">        DO k</div>
<div style="margin-left:40px;"> A(5, i+1, j) = A(N, i, k) + C</div>
<div style="margin-left:30px;">   ENDDO</div>
<div style="margin-left:20px;">    ENDDO</div>
<div style="margin-left:10px; margin-bottom:10px;">ENDDO</div>
</div>
<div>When testing for a true dependence between the two references to A in the sample fragment, the first subscript is ZIV, the second is SIV, and the third is MIV. Remember again the convention that “subscript” in this context means a pair of corresponding subscripts.</div>
</div>-->

</div>
</div>
</div>

<div style="display:hidden;">
<div id="ex1" class="modal" style="margin:50px; 0">
    <h2>Getting Started</h3>
    <h3>1. About the tool</h3>
    <p>This is an interactive application where you can input code and receive an analysis of the dependencies inherent to the code. You can use the tool to purely compute the dependencies by generating a interation space or a dependence graph of the input program, but the tool also has a didactic element to it where you can learn about various subscript types, classify them and later test for independence.</p>
    <p>Please use Chrome <img src="img/chrome_icon.png" width="5%" style="margin-right:2px;">.</p>
    <h3>2. Fortran</h2>
    <p>The tool uses Fortran as its input language. As you only need to learn how to write do-loops and make assignments to array calls, you can feel free to load some of the test provided and quickly get the hang of it. For reference, here is what you need to know for the purpose of this tool:</p>
    <p>Assignments:<div style="margin-left:20px; font-family:'Courier New', Courier, monospace;">A(I,J)=A(I,J-1)+A(2,3)</div></p>
    <p>Do-loops:
            <div style="font-family:'Courier New', Courier, monospace">
                <div style="margin-left:20px;">DO I=START,END</div>
                <div style="margin-left:40px;">DO J=START,END</div>
                <div style="margin-left:60px;">STATEMENT</div>
                <div style="margin-left:60px;">STATEMENT</div>
                <div style="margin-left:40px;">ENDDO</div>
                <div style="margin-left:20px;">ENDDO</div>
            </div></p>
    <p>Note: inclusive END, for DO I=1,5 => 5 iterations</p>
    <p>Supported operators: <span style="font-family: 'Courier New', Courier, monospace">+, -, *, /</span></p>
    <p>It supports unknown variables for the purpose of subscript tests. You can though N = 10 and use it for iteration space or dependence graph.</p>
																						<h3>3. Purpose</h3>
																						<p>Why is this interesting at all? Why do we care about dependency in a given program? Consider the following example:</p>
																						<p>
<div style="font-family:'Courier New', Courier, monospace">
                <div style="margin-left:20px;">DO I=1,N</div>
                <div style="margin-left:40px;">A(I)=A(I-2)+X</div>
                <div style="margin-left:20px;">ENDDO</div>
            </div>																					
																						</p>
											  <p>We can notice in this simple piece of code that: any given iteration depends on the second previous iteration being executed first (there is a read after write dependence), but not on the previous one. Knowing this we can execute two consecutive iterations in parallel, rather than iterating through the loop one at a time, thus improving the execution of the program.</p>
																						<h3>4. Layout</h3>
    <p>The left-hand side of the tool is dedicated to input code. Complementary to the compiler, there is PARSE button that locks in your code and provides a visualization. Here you can select which parts of the code to run/analyze - a description of the labels is available there. LOAD TEST provides a list of predefined programs that you might be interested to analyze (code from Compiler Dependence books). The console provides feedback on the input code.</p>
    <p>On the right-hand side there 3 options:
        <ul><li>Iteration Space</li>
        <li>Dependence Graph</li>
        <li>Subscript Tests</li></ul>
    The first two are visualization/description methods of the dependence in the code. And subscripts are used to separate pairs of arrays in order to analyze dependence. More on these on their respective tabs.
    </p>
</div>
</div>

  <div class="footer-container">
  </div>
  <script>
  var handle = 'unknown';
  function load_test(nr) {
    var test = [];
    test[1] = `DO I=1,4
	DO J=1,5
    	A(I,J)=A(I,J-1)
    ENDDO
ENDDO
`;
    test[2] = `DO I=1,4
	DO J=1,4
    	A(I,J)=A(I,J+1)
    ENDDO
ENDDO
`;
    test[3] = `DO I=1,3
	DO J=1,3
    	A(I,1)=A(I+10,J+10)
    ENDDO
ENDDO
`;
    test[4] = `DO I=1,5
	DO J=1,5
    	A(I,J)=A(I-1,J-1)+10
    ENDDO
ENDDO
`;
    test[5] = `DO I=1,3
	DO J=1,3
    	A(I,J)=A(2,2)
    ENDDO
ENDDO
`;
    test[6] = `DO I=1,3
	DO J=1,3
    	A(I,J)=A(J,I)
    ENDDO
ENDDO
`;
    test[7] = `DO I=1,3
	DO J=1,3
    	A(I-1,J-1)=A(I,J)
    	A(I,J)=A(I,J-1)
    ENDDO
ENDDO
`;
    test[8] = `DO I=1,5
	DO J=1,5
    	A(I,J-1)=A(I,J)
        A(I,J)=A(I-1,J-1)
    ENDDO
ENDDO
`;
    test[9] = `N=10
    DO I = 1,100
	X(I) = Y(I) + 10
	DO J = 1,100
		B(J) = A(J,N)
		DO K = 1,100
 			A(J+1,K) = B(J)+C(J,K)
		ENDDO
		Y(I+J) = A(J+1,N)
	ENDDO
ENDDO
`;
// MORE DEPENDENCY GRAPH
test[10] = `DO I = 1, 100
    DO J = 1, 100
        A(I+1,J) = B + A(I,J+1)
    ENDDO
ENDDO
`;
test[11] = `DO I = 1,100
    Y(I) = A + X(I,10)
    DO J = 1, 100
        X(I+1,J) = Z(I,J) + Y(I)
    ENDDO
    W(I) = A + X(I+1,20)
ENDDO
`;
// ZIV
test[12] = `DO I = 1,10
    A(2,2,I) = A(2,3,I+1) + 10
ENDDO
`;
test[13] = `DO I = 1,10
    A(I,2) = A(I,3) + A(I,N)
ENDDO
`;
// STRONG
test[14] = `DO I = 1,10
    DO J = 1,10
        A(2*I+4,2*J+6) = A(2*I+7,2*J+4) + X
    ENDDO
ENDDO
`;
test[15] = `DO I = 1,10
    A(2*I+9) = A(2*I-2) + 10
ENDDO
`;
test[16] = `DO I = 1,10
    A(5*I+N) = A(5*I+2*N+6) + 10
ENDDO
`;
// WEAK ZERO
test[17] = `DO I = 1,10
    A(2*I+5) = A(4) + 10
ENDDO
`;
test[18] = `DO I = 1,10
    DO J = 1,10
        A(3*I+5,2*J+7) = A(11,11)
    ENDDO
ENDDO
`;
// WEAK CROSSING
test[19] = `DO I = 1,10
    DO J = 1,10
        A(2*I+N,J+5) = A(-2*I+N,-J+2)+ 10
    ENDDO
ENDDO
`;
test[20] = `DO I = 1,10
    A(3*I+5) = A(-3*I+4) + 10
ENDDO
`;
// WEAK
test[21] = `DO I = 1,10
    A(2*I+7) = A(4*I-3) + 10
ENDDO
`;
test[22] = `DO I = 1,10
    A(2*I+7) = A(4*I-2) + 10
ENDDO
`;
test[23] = `DO I = 1,10
    DO J = 1,10
        A(3*I,6*J+9) = A(2*I,3*J-2) + 10
    ENDDO
ENDDO
`;
// MIV
test[24] = `DO I = 1,10
    DO J = 1,10
        A(2*I+7) = A(4*J-4) + 10
    ENDDO
ENDDO
`;
test[25] = `DO I = 1,10
    DO J = 1,10
        A(4*I+10) = A(J+3) + 10
    ENDDO
ENDDO
`;
// COUPLED
test[26] = `DO I = 1,10
    A(I,2*I+3) = A(I+1,3*I-1) + 10
ENDDO
`;
test[27] = `DO I = 1,10
    DO J = 1,10
        A(4*I+10,2*J+3) = A(J+3,I+4) + 10
    ENDDO
ENDDO
`;
    $editor.setValue(test[nr]);
    document.getElementById('parse_button').click();
    refresh();
}


/*var colors = new Array(
  //[62,35,255],
  //[60,255,60],
  //[255,35,98],
  //[45,175,230],
  //[255,0,255],
  //[255,128,0]
  [255,108,28],
  [232,54,48],
  [255,52,178],
  [255,170,38]);

var step = 0;
//color table indices for: 
// current color left
// next color left
// current color right
// next color right
var colorIndices = [0,1,2,3];

//transition speed
//var gradientSpeed = 0.0003;
var gradientSpeed = 0;

function updateGradient()
{
  
  if ( $===undefined ) return;
  
var c0_0 = colors[colorIndices[0]];
var c0_1 = colors[colorIndices[1]];
var c1_0 = colors[colorIndices[2]];
var c1_1 = colors[colorIndices[3]];

var istep = 1 - step;
var r1 = Math.round(istep * c0_0[0] + step * c0_1[0]);
var g1 = Math.round(istep * c0_0[1] + step * c0_1[1]);
var b1 = Math.round(istep * c0_0[2] + step * c0_1[2]);
var color1 = "rgb("+r1+","+g1+","+b1+")";

var r2 = Math.round(istep * c1_0[0] + step * c1_1[0]);
var g2 = Math.round(istep * c1_0[1] + step * c1_1[1]);
var b2 = Math.round(istep * c1_0[2] + step * c1_1[2]);
var color2 = "rgb("+r2+","+g2+","+b2+")";

 $('#header').css({
   background: "-webkit-gradient(linear, left top, right top, from("+color1+"), to("+color2+"))"}).css({
    background: "-moz-linear-gradient(left, "+color1+" 0%, "+color2+" 100%)"});
  
  step += gradientSpeed;
  if ( step >= 1 )
  {
    step %= 1;
    colorIndices[0] = colorIndices[1];
    colorIndices[2] = colorIndices[3];
    
    //pick two new target color indices
    //do not pick the same as the current one
    colorIndices[1] = ( colorIndices[1] + Math.floor( 1 + Math.random() * (colors.length - 1))) % colors.length;
    colorIndices[3] = ( colorIndices[3] + Math.floor( 1 + Math.random() * (colors.length - 1))) % colors.length;
    
  }
}

setInterval(updateGradient,10);*/


function openTab(evt, tabname) {
  // Declare all variables
  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(tabname).style.display = "block";
  evt.currentTarget.className += " active";
  if (parsed == true) {
    run_active();
  }
}

function openTabPart(evt, tabname) {
  // Declare all variables
  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("parttab");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("parttab_button");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(tabname).style.display = "block";
  evt.currentTarget.className += " active";
}

function openTabCoupled(evt, tabname) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcoupled");
    for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tabcoupled_button");
    for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(tabname).style.display = "block";
    evt.currentTarget.className += " active";
}


// EDITOR

var $editor = CodeMirror(document.getElementById('code'), {
  value: "INPUT CODE HERE...",
  mode:  "javascript",
  lineNumbers: true
});

// GLOBAL DECLS

var ast;
var tab;
var tab_size = 40;
var line_cnt;
var read_cnt;
var vwrites;
var vreads;
var stmts;
var writes_register = new Map();
var reads_register = new Map();
var stmt_register = new Map();
var writes_enum = new Map();
var reads_enum = new Map();
var visualizer = document.getElementById('visualizer');
var vis_under = document.getElementById('vis_under');
var too_deep = 0;
var change = false;
var parsed = false;
var wrs = new Map();
var selection_mode = false;
var iterators = new Map();
var reads_selected = new Map();
var writes_selected = new Map();
var itt = 1;
var iterators_se = new Dict();

// CONSOLE INIT
function add_to_console(line,color) {
        var d = new Date();
        var ul = document.getElementById("console");
        var li = document.createElement("li");
        li.appendChild(document.createTextNode(d.toLocaleTimeString()+": "+line));
        li.style = "color: "+color+";";
        ul.appendChild(li);
        ul.scrollTop = ul.scrollHeight;
    }

add_to_console("App loaded","#c7c7c7");
// CONSOLE INIT END

// PARSE ACTIVATOR *** ***
document.getElementById("parse_button").addEventListener("click", function(){
    refresh();
    var input = $editor.getValue();
    input += '\n';

// REFRESH ...

//save_info('input_code',input);

/*$.ajax({
    url: 'input_code.php',
    type: "POST",
    dataType: 'json',
    data: ({
        user: handle,
        code: input
    })
});*/

// // ROOT
visualizer.removeChild(root);
root = document.createElement('div');
root.id = "root";
visualizer.insertBefore(root,vis_under);

// // COUNTERS

tab = 0;
line_cnt = 0;
vwrites = 0;
vreads = 0;
stmts = 0;
writes_register = new Map();
reads_register = new Map();
stmt_register = new Map();
writes_enum = new Map();
reads_enum = new Map();
too_deep = 0;
selection_mode = false;
iterators = new Map();
reads_selected = new Map();
writes_selected = new Map();
iterators_se = new Dict();
itt = 1;

// PARSE 

add_to_console('Parsing...','#c7c7c7');
ast = parse_routine(input);
code_visualizer(ast); // VISUALIZATION
add_event_listeneners(); // LISTENERS
parsed = true;
add_to_console('Parsing done','#c7c7c7');

// PARSE END

// // FUNCTIONS NEEDED FOR VISUALIZATION

function add_event_listeneners() {
    var i;
    for (i = 1; i <= vwrites; i++) {
        document.getElementById("vwrite_"+i).addEventListener("click", function() {
            var i = parseInt(this.id.substring(7,this.id.length));
            if (!selection_mode) { 
                if (writes_register.has(i)) {
                    writes_register.delete(i);
                    this.style.background = "rgba(50, 50, 136, 0.6)";
                }
                else {
                    writes_register.set(i,true);
                    this.style.background = "blue";
                }
                if (document.getElementById("auto_run").checked) {
                    run_active();
                }
                else {
                    change = true;
                }
            }
            else {
                if (writes_selected.has(i)) {
                    writes_selected.delete(i);
                    if (writes_register.has(i)) this.style.background = "blue";
                    else this.style.background = "rgba(50, 50, 136, 0.6)";
                }
                else {
                    if (writes_selected.length == 0 || writes_selected.length == 1 && reads_selected.length == 0) {
                        writes_selected.set(i,true);
                        this.style.background = "orange";
                    }
                }
            }
        });
        writes_register.set(i,true);
        document.getElementById("vwrite_"+i).style.background = "blue";
    }
    for (i = 1; i <= vreads; i++) {
        document.getElementById("vread_"+i).addEventListener("click", function() {
            var i = parseInt(this.id.substring(6,this.id.length));
            if (!selection_mode) {
                if (reads_register.has(i)) {
                    reads_register.delete(i);
                    this.style.background = "rgba(180, 37, 37, 0.65)";
                }
                else {
                    reads_register.set(i,true);
                    this.style.background = "red";
                }
                if (document.getElementById("auto_run").checked) {
                    run_active();
                }
                else {
                    change = true;
                }
            }
            else {
                if (reads_selected.has(i)) {
                    reads_selected.delete(i);
                    if (reads_register.has(i)) this.style.background = "red";
                    else this.style.background = "rgba(180, 37, 37, 0.65)";
                }
                else {
                    if (reads_selected.length == 0) {
                        if (writes_selected.length <= 1) {
                            reads_selected.set(i,true);
                            this.style.background = "orange";
                        }
                    }
                }
            }
        });
        reads_register.set(i,true);
        document.getElementById("vread_"+i).style.background = "red";
    }
    for (i = 1; i <= stmts; i++) {
        document.getElementById("stmt_"+i).addEventListener("click", function() {
            var i = parseInt(this.id.substring(5,this.id.length));
            if (stmt_register.has(i)) {
                stmt_register.delete(i);
                this.style.background = "rgb(167, 165, 165)";
            }
            else {
                stmt_register.set(i,true);
                this.style.background = "#666";
            }
            if (document.getElementById("auto_run").checked) {
                run_active();
            }
            else {
                change = true;
            }
        });
        stmt_register.set(i,true);
        document.getElementById("stmt_"+i).style.background = "#666";
    }
}

function add_tab(node) {
    node.style.marginLeft = (tab*tab_size)+"px";
}

function code_visualizer (ast) {
    for (var i = 0 ; i < ast.stmt_list.length; i ++) {
        root.appendChild(code_visualizer_stmt(ast.stmt_list[i]));
    }
}

function code_visualizer_stmt (stmt) {
    var s = document.createElement('div');
    if (stmt.type == "do") {
        iterators.set(stmt.it,itt++);
        s.appendChild(code_visualizer_do_top(stmt));
        tab ++;
        if (tab == 3) { too_deep = 1; }
        for (var i = 0; i < stmt.stmt_list.length; i ++) {
            s.appendChild(code_visualizer_stmt(stmt.stmt_list[i]));
        }
        tab --;
        iterators.delete(stmt.it);
        itt--;
        s.appendChild(code_visualizer_do_end());
        return s;
    }
    else if (stmt.type == "assign") {
        s.id = "line_"+(++line_cnt);
        s.innerHTML = '<span class="stmt" id="stmt_'+stmt.nr+'">S'+stmt.nr+'</span> '+code_visualizer_assign(stmt);
        stmts = stmt.nr;
        add_tab(s);
    }
    return s;
}

function code_visualizer_do_top(stmt) {
    var top = document.createElement('div');
    top.id = "line_"+(++line_cnt);
    var x = document.createTextNode("DO "+stmt.it+" = "+code_visualizer_evaluate(stmt.start)[0]+","+code_visualizer_evaluate(stmt.end)[0]);
    iterators_se.set(stmt.it,[stmt.start,stmt.end]);
    top.appendChild(x);
    add_tab(top);
    return top;
}

function code_visualizer_do_end() {
    var end = document.createElement('div');
    end.id = "line_"+(++line_cnt);
    end.textContent = "ENDDO";
    add_tab(end);
    return end;
}

function code_visualizer_assign(stmt) {
    return code_visualizer_evaluate(stmt.lhs,'lhs')[0]+" = "+code_visualizer_evaluate(stmt.rhs,'rhs')[0];
}

function code_visualizer_evaluate(expr,side) {
    if (expr == null) {
        return [null,1];
    }
    else if (expr.type == 'op') {
        var lhs = code_visualizer_evaluate(expr.lhs,side);
        var rhs = code_visualizer_evaluate(expr.rhs,side);
        if (expr.lhs == null) {
            if (expr.op == '-') return ["(-" + rhs[0] + ")",rhs[1]];
            else return [rhs[0],rhs[1]];
        }
        else {
            if (expr.op == '+' || expr.op == '-') {
                return [lhs[0]+expr.op+rhs[0],2];
            }
            else {
                if (lhs[1] == 2 && rhs[1] == 2) {
                    return ["(" + lhs[0] + ")" + expr.op + "(" + rhs[0] + ")",1];
                }
                else if (lhs[1] == 2 && rhs[1] == 1) {
                    return ["(" + lhs[0] + ")" + expr.op + rhs[0],1];
                }
                else if (lhs[1] == 1 && rhs[1] == 2) {
                    return [lhs[0] + expr.op + "(" + rhs[0] + ")",1];
                }
                return [lhs[0]+expr.op+rhs[0],1];
            }
        }
    }
    else if (expr.type == 'val') {
        return [expr.val,1];
    }
    else if (expr.type == 'var') {
        return [expr.variable,1];
    }
    else if (expr.type == 'array') {
        var out = "";
        var c;
        if (side == 'lhs') {
            out += '<span class="vwrite" id="vwrite_'+(++vwrites)+'">';
            expr.write_id = vwrites;
            expr.iterators_at = iterators.entriesArray();
            writes_enum.set(vwrites,expr);
        }
        else if (side == 'rhs') {
            out += '<span class="vread" id="vread_'+(++vreads)+'">';
            expr.read_id = vreads;
            expr.iterators_at = iterators.entriesArray();
            reads_enum.set(vreads,expr);
        }
        out += expr.id+"(";
        expr.index_text = new Array();
        for (var i = 0; i < expr.index_list.length; i++) {
            c = code_visualizer_evaluate_inside(expr.index_list[i])[0];
            expr.index_text.push(c);
            out += c + ",";
        }
        out = out.substring(0,out.length-1);
        return [out+")</span>",1];
    }
}

function code_visualizer_evaluate_inside(expr) {
    if (expr == null) {
        return [null,1];
    }
    else if (expr.type == 'op') {
        var lhs = code_visualizer_evaluate(expr.lhs);
        var rhs = code_visualizer_evaluate(expr.rhs);
        if (expr.lhs == null) {
            if (expr.op == '-') return ["(-" + rhs[0] + ")",rhs[1]];
            else return [rhs[0],rhs[1]];
        }
        else {
            if (expr.op == '+' || expr.op == '-') {
                return [lhs[0]+expr.op+rhs[0],2];
            }
            else {
                if (lhs[1] == 2 && rhs[1] == 2) {
                    return ["(" + lhs[0] + ")" + expr.op + "(" + rhs[0] + ")",1];
                }
                else if (lhs[1] == 2 && rhs[1] == 1) {
                    return ["(" + lhs[0] + ")" + expr.op + rhs[0],1];
                }
                else if (lhs[1] == 1 && rhs[1] == 2) {
                    return [lhs[0] + expr.op + "(" + rhs[0] + ")" ,1];
                }
                return [lhs[0]+expr.op+rhs[0],1];
            }
        }
    }
    else if (expr.type == 'val') {
        return [expr.val,1];
    }
    else if (expr.type == 'var') {
        return [expr.variable,1];
    }
    else if (expr.type == 'array') {
        var out = expr.id+"(";
        for (var i = 0; i < expr.index_list.length; i++) {
            out += code_visualizer_evaluate_inside(expr.index_list[i])[0] + ",";
        }
        out = out.substring(0,out.length-1) + ")";
        return [out,1];
    }
}

// FUNCTIONS NEEDED FOR VISUALIZATION END



// CHANGE ENVIRONMENT 

document.getElementById('editor').style.display = "none";
visualizer.style.display = "block";
run_active();
//options_bar.style.display = "inline-block";

// CHANGE ENVIRONMENT END

});

document.getElementById("edit_button").addEventListener("click", function(){
    document.getElementById('editor').style.display = "block";
    visualizer.style.display = "none";
    refresh();
    //options_bar.style.display = "none";
});




// GLOBALS FOR SIMULATION

    // SIM
    iterators = new Map();
    var reads = new Map();
    var writes = new Map();
    var reads_it = new Map();
    var writes_it = new Map();
    var current_stmt = 0;
    var variables_in_array = new Array();
    var variables_in_iterator = new Array();
    var iterations_1 = new Array();
    var iterations_2 = new Array();
    var stop_the_program = false;
    var clean = false;
    var known_vars = new Map();
    var lhs_incorrect = false;

    // DEPS
    var raw = new Array();
    var war = new Array();
    var waw = new Array();
    var raw_it = new Array();
    var war_it = new Array();
    var waw_it = new Array();
    var raw_map = new Map();
    var war_map = new Map();
    var waw_map = new Map();

    // HELP

    var i;
    var j;
    var k;
    var h;
    var cnt = 1;
    var spacing;
    var current_x;
    var current_y;
    var width;
    var height;
    var node_size;
    var graph_links = new Map();
    var multi = new Map();
    var deepness = 0;
    var max_deepness = 0;
    var edges_added = new Map();
    var network;

// GLOBALS FOR SIMULATION END


// FUNCTIONS FOR SIMULATION *** *** 

function Memory(key) {
    //this.id = id;
    //this.indices = indices;
    this.key = key;
}

function it_diff(it1, it2) {
    var result = 1;
    var smaller_size = it1.length < it2.length ? it1.length : it2.length;
    for (var i = 0; i < smaller_size; i ++) {
        if (it1[i][1] == it2[i][1]) {
            result++;
        }
        else {
            break;
        }
    }
    if (result == smaller_size + 1) {
        result = -1;
    }
    return result;
}

function evaluate(expr) { // A(expr,expr) -> evaluates expr for current iteration
    var type = expr.type;
    var op = expr.op;
    var lhs = expr.lhs;
    var rhs = expr.rhs;

    if ( type == "op" ) {
        if (lhs == null) {
            if (op == "-") return -evaluate(rhs);
            else if (op == "+") return evaluate(rhs);
            // else console.log("Not a valid operation: "+expr);
        }
        else {
            if (op == "+") return evaluate(lhs) + evaluate(rhs);
            else if (op == "-") return evaluate(lhs) - evaluate(rhs);
            else if (op == "*") return evaluate(lhs) * evaluate(rhs);
            else if (op == "/") return evaluate(lhs) / evaluate(rhs);
            else if (op == "%") return evaluate(lhs) % evaluate(rhs);
            else if (op == ".LT.") return evaluate(lhs) < evaluate(rhs);
            else if (op == ".LE.") return evaluate(lhs) <= evaluate(rhs);
            else if (op == ".GT.") return evaluate(lhs) > evaluate(rhs);
            else if (op == ".GE.") return evaluate(lhs) >= evaluate(rhs);
            else if (op == ".EQ.") return evaluate(lhs) == evaluate(rhs);
            else if (op == ".NE.") return evaluate(lhs) != evaluate(rhs);
            else if (op == ".OR.") return evaluate(lhs) || evaluate(rhs);
            else if (op == ".AND.") return evaluate(lhs) && evaluate(rhs);
            //else console.log("Not a valid operation: "+expr);
        }
    }
    else if ( type == "val" ) {
        return expr.val;
    }
    else if (type == "var" ) {
        if (iterators.has(expr.variable)) return iterators.get(expr.variable);
        else if (known_vars.has(expr.variable)) return known_vars.get(expr.variable);
        else {
            clean = false;
            return 0;
        }
    }
    else if (type == "array") {
        clean = false;
        if (stmt_register.has(current_stmt)) {
        if (reads_register.has(expr.read_id)) {
            simulate_array(expr);
        } }
        return 0;
    }
    else {
        return 0;
    }
}

function evaluate_left(expr) { // A(expr,expr) -> evaluates expr for current iteration
    var type = expr.type;

    if (type == "var") {
        return expr.variable;
    }
    else if (type == "array") {
        clean = false;
        if (stmt_register.has(current_stmt)) {
        if (writes_register.has(expr.write_id)) {
            simulate_array(expr);
        } }
        return 0;
    }
    else {
        clean = false;
        stop_the_program = true;
        lhs_incorrect = true;
    }
}

function evaluate_array(expr) { // A(expr,expr) -> evaluates expr for current iteration
    var type = expr.type;
    var op = expr.op;
    var lhs = expr.lhs;
    var rhs = expr.rhs;

    if ( type == "op" ) {
        if (lhs == null) {
            if (op == "-") return -evaluate_array(rhs);
            else if (op == "+") return evaluate_array(rhs);
            // else console.log("Not a valid operation: "+expr);
        }
        else {
            if (op == "+") return evaluate_array(lhs) + evaluate_array(rhs);
            else if (op == "-") return evaluate_array(lhs) - evaluate_array(rhs);
            else if (op == "*") return evaluate_array(lhs) * evaluate_array(rhs);
            else if (op == "/") return evaluate_array(lhs) / evaluate_array(rhs);
            else if (op == "%") return evaluate_array(lhs) % evaluate_array(rhs);
            //else console.log("Not a valid operation: "+expr);
        }
    }
    else if ( type == "val" ) {
        return expr.val;
    }
    else if (type == "var" ) {
        if (iterators.has(expr.variable)) return iterators.get(expr.variable);
        else if (known_vars.has(expr.variable)) return known_vars.get(expr.variable);
        else {
            clean = false;
            stop_the_program = true;
            variables_in_array.push(expr.variable);
            return 0;
        }
    }
    else if (type == "array") {
        variables_in_array.push(expr.id);
        clean = false;
        stop_the_program = true;
        return 0;
    }
    else {
        //console.log("Not a valid expr: "+expr); 
    }
}

function evaluate_iterator(expr) { // A(expr,expr) -> evaluates expr for current iteration
    var type = expr.type;
    var op = expr.op;
    var lhs = expr.lhs;
    var rhs = expr.rhs;

    if ( type == "op" ) {
        if (lhs == null) {
            if (op == "-") return -evaluate_iterator(rhs);
            else if (op == "+") return evaluate_iterator(rhs);
            // else console.log("Not a valid operation: "+expr);
        }
        else {
            if (op == "+") return evaluate_iterator(lhs) + evaluate_iterator(rhs);
            else if (op == "-") return evaluate_iterator(lhs) - evaluate_iterator(rhs);
            else if (op == "*") return evaluate_iterator(lhs) * evaluate_iterator(rhs);
            else if (op == "/") return evaluate_iterator(lhs) / evaluate_iterator(rhs);
            else if (op == "%") return evaluate_iterator(lhs) % evaluate_iterator(rhs);
            //else console.log("Not a valid operation: "+expr);
        }
    }
    else if ( type == "val" ) {
        return expr.val;
    }
    else if (type == "var" ) {
        if (iterators.has(expr.variable)) return iterators.get(expr.variable);
        else if (known_vars.has(expr.variable)) return known_vars.get(expr.variable);
        else {
            stop_the_program = true;
            clean = false;
            variables_in_iterator.push(expr.variable);
            return 0;
        }
    }
    else if (type == "array") {
        stop_the_program = true;
        clean = false;
        variables_in_iterator.push(expr.variable);
        return 0;
    }
    else {
        //console.log("Not a valid expr: "+expr); 
    }
}

function simulate_array(expr) {
    if (expr.type == "array") {
        var memory = get_memory(expr).key;
        if (option == 2) {
            if (side == "lhs") {
                // testing dependency
                if (writes.has(memory)) {
                    var m = writes.get(memory).entriesArray();
                    for (var i = 0; i < m.length; i ++) {
                        if (!waw_map.has([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())].toString())) {
                            waw.push([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())]);
                            waw_map.set([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())].toString(),1);
                        }
                        if (!waw_map.has([m[i][0],current_stmt,it_diff(iterators.entriesArray(),m[i][1])].toString())) {
                            waw.push([m[i][0],current_stmt,it_diff(iterators.entriesArray(),m[i][1])]);
                            waw_map.set([m[i][0],current_stmt,it_diff(iterators.entriesArray(),m[i][1])].toString(),1);
                        }
                    }
                }

                if (reads.has(memory)) {
                    var m = reads.get(memory).entriesArray();
                    for (var i = 0; i < m.length; i ++) {
                        if (!war_map.has([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())].toString())) {
                            war.push([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())]);
                            war_map.set([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())].toString(),1);
                        }
                    }
                }

                // adding write
                if (writes.has(memory)) {
                    var m = writes.get(memory);
                    if (!m.has(current_stmt)) {
                        m.set(current_stmt,iterators.entriesArray());
                    }
                }
                else {
                    var m = new Map();
                    m.set(current_stmt,iterators.entriesArray());
                    writes.set(memory,m);
                }
                reads.delete(memory);
            }
            else if (side == "rhs") {
                // testing dependency
                if (writes.has(memory)) {
                    var m = writes.get(memory).entriesArray();
                    for (var i = 0; i < m.length; i ++) {
                        if (!raw_map.has([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())].toString())) {
                            raw.push([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())]);
                            raw_map.set([m[i][0],current_stmt,it_diff(m[i][1],iterators.entriesArray())].toString(),1);
                        }
                    }
                }

                // adding read
                if (reads.has(memory)) {
                    var m = reads.get(memory);
                    if (!m.has(current_stmt)) {
                        m.set(current_stmt,iterators.entriesArray());
                    }
                }
                else {
                    var m = new Map();
                    m.set(current_stmt,iterators.entriesArray());
                    reads.set(memory,m);
                }
            }
        }
        else {
            if (side == "lhs") {
                // testing dependency
                if (writes_it.has(memory)) {
                    var m = writes_it.get(memory);
                    waw_it.push([m,iterators.entriesArray()]);
                }

                if (reads_it.has(memory)) {
                    var m = reads_it.get(memory);
                    for (var i = 0; i < m.length; i ++) {
                        war_it.push([iterators.entriesArray(),m[i]]);
                    }
                }

                // adding write
                writes_it.set(memory,iterators.entriesArray());
                reads_it.delete(memory);
            }
            else if (side == "rhs") {
                // testing dependency
                if (writes_it.has(memory)) {
                    var m = writes_it.get(memory);
                    raw_it.push([m,iterators.entriesArray()]);
                }

                // adding read
                if (reads_it.has(memory)) {
                    var m = reads_it.get(memory);
                }
                else {
                    var m = new Array();
                    reads_it.set(memory,m);
                }
                m.push(iterators.entriesArray());
            }
        }
    }
}

function simulate_stmts(stmt_list) {
    for (var i = 0; i < stmt_list.length; i++) {
        var stmt = stmt_list[i];
        if (stmt.type == "do") {
            simulate_do(stmt);
        }
        else if (stmt.type == "assign") {
            current_stmt = stmt.nr;
            clean = true;
            var from;
            var to;
            side = "rhs";
            from = evaluate(stmt.rhs);
            if (clean) {
                side = "lhs";
                to = evaluate_left(stmt.lhs);
                if (clean) {
                    known_vars.set(to,from);
                }
            }
            else {
                side = "lhs";
                to = evaluate_left(stmt.lhs);
            }
        }
        else if (stmt.type == "if") {
            if (evaluate(stmt.expr)) {
                simulate_stmts(stmt.if_part);
            }
            else if (stmt.else_if_part != null) {
                for (i = 0; i < stmt.else_if_part.else_if_list.length; i ++) {
                    if (evaluate(stmt.else_if_part.else_if_list[i].expr)) {
                        simulate_stmts(stmt.else_if_part.else_if_list[i].stmt_list);
                        break;
                    }
                }
            }
            else if (stmt.else_part != null) {
                simulate_stmts(stmt.else_part.stmt_list);
            }
        }
    }
}

function simulate_do(do_stmt) {
    var it = do_stmt.it;
    iterators.set(it,evaluate_iterator(do_stmt.start));
    var step;
    if (do_stmt.step == null) step = 1;
    else { step = evaluate_iterator(do_stmt.step); }
    deepness++;
    //if (deepness > 2 && option == 1) {  too_deep = 1; }
    if (!stop_the_program) { 

    if (iterators.get(it) >= evaluate_iterator(do_stmt.end) && too_deep == 0) {
        if (step > 0) { step = -step; }

        while (iterators.get(it) >= evaluate_iterator(do_stmt.end) ) {
            if (option == 1) {
                if (deepness == 1) {
                    iterations_1.push(iterators.entriesArray());
                }
                else {
                    iterations_2.push(iterators.entriesArray());
                }
            }
            simulate_stmts(do_stmt.stmt_list);
            var next_step = iterators.get(it)+step;
            iterators.set(it,next_step);
        }
    }
    else {
        while (iterators.get(it) <= evaluate_iterator(do_stmt.end) ) {
            if (option == 1) {
                if (deepness == 1) {
                    iterations_1.push(iterators.entriesArray());
                }
                else {
                    iterations_2.push(iterators.entriesArray());
                }
            }
            simulate_stmts(do_stmt.stmt_list);
            var next_step = iterators.get(it)+step;
            iterators.set(it,next_step);
        }
    }
    }
    deepness--;
    iterators.delete(it);
}

function get_memory(array_call) { // eg A(i,j) with i = 5, j = 2 -> MEM(A:5,2)
    var id = array_call.id;
    var indices = [];
    var key = "";

    var key = id + ":";

    for (var i = 0; i < array_call.index_list.length; i++) {
        current_index = evaluate_array(array_call.index_list[i],true);
        indices.push(current_index);
        key += current_index + ",";
    }

    key = key.substring(0,key.length-1);

    return new Memory(key);
}

function run_simulation(ast) {
    simulate_stmts(ast.stmt_list);
}

function calculate_graph_point() {
    var node_itself = [];
    var distance_in_between = [];
    var diff;
    if (max_deepness == 1) {
        diff = iterations_1.length-1;
        space_per_node = Math.floor((width*0.9)/(diff+1));
        node_itself[0] = Math.ceil(space_per_node*0.7);
        distance_in_between[0] = Math.floor(space_per_node*0.3);
        return [node_itself[0],distance_in_between[0]];
    }
    else if (max_deepness == 2) {
        diff = iterations_1.length-1;
        space_per_node = Math.floor((height*0.9)/(diff+1));
        node_itself[0] = Math.ceil(space_per_node*0.4);
        distance_in_between[0] = Math.floor(space_per_node*0.6);
        diff = (iterations_2.length/iterations_1.length)-1;
        space_per_node = Math.floor((width*0.9)/(diff+1));
        node_itself[1] = Math.ceil(space_per_node*0.7);
        distance_in_between[1] = Math.floor(space_per_node*0.3);
        return [node_itself,distance_in_between];
    }   
    return null;
}

function get_distance(dep) {
    var arr = new Array();
    var from = dep[0];
    var to = dep[1];
    if (from.length < to.length) {
        for (var i = 0; i < from.length; i++) {
            arr.push(to[i][1]-from[i][1]);
        }
        return arr;
    }
    else {
        for (var i = 0; i < to.length; i ++) {
            arr.push(to[i][1]-from[i][1]);
        }
        return arr;
    }
}

function get_direction(dist) {
    for (var i = 0; i < dist.length; i++) {
        if (dist[i] > 0) dist[i] = '<';
        else if (dist[i] < 0) dist[i] = '>';
        else dist[i] = '=';
    }
    return dist;
}

function get_delta(dep,type) {
    var build = "δ";
    if (type == 'war') {
        build = build + "⁻¹";
    }
    else if (type == 'waw') {
        build = build + "⁰";
    }
    if (dep == -1) {
        build = build + "∞";
    }
    else {
        var sub;
        if (dep == 1) {
            sub = '₁';
        }
        else if (dep == 2) {
            sub = '₂';
        }
        else if (dep == 3) {
            sub = '₃';
        }
        else if (dep == 4) {
            sub = '₄';
        }
        else if (dep == 5) {
            sub = '₅';
        }
        else if (dep == 6) {
            sub = '₆';
        }
        else if (dep == 7) {
            sub = '₇';
        }
        else if (dep == 8) {                           
            sub = '₈';
        }
        else if (dep == 9) {
            sub = '₉';
        }

        build = build + sub;
    }
    return build;
}

/// FUNCTIONS FOR SIMULATION END *** ***



/// SIMULATION

// ITERATION SPACE
function make_iteration_space () {
    add_to_console("Running simulation with option: iteration space...",'#c7c7c7');
    option = 1;
    $("#IterationSpace").animate({ scrollTop: 0 }, "fast");

    // REFRESH ...

    iterators = new Map();
    reads = new Map();
    writes = new Map();
    reads_it = new Map();
    writes_it = new Map();
    current_stmt = 0;
    variables_in_array = new Array();
    variables_in_iterator = new Array();
    iterations_1 = new Array();
    iterations_2 = new Array();
    stop_the_program = false;
    clean = false;
    known_vars = new Map();
    lhs_incorrect = false;

    raw = new Array();
    war = new Array();
    waw = new Array();
    raw_it = new Array();
    war_it = new Array();
    waw_it = new Array();
    raw_map = new Map();
    war_map = new Map();
    waw_map = new Map();

    // HELP
    cnt = 1;
    graph_links = new Map();
    multi = new Map();
    deepness = 0;
    max_deepness = 0;
    edges_added = new Map();
    height = 532;
    
    document.getElementById('is_network').innerHTML = "";

    if (too_deep == 1) {
        add_to_console("ERROR [Dimensionality too large]. Use 1D or 2D loops for option: iteration space",'orange');
    }
    else {
        run_simulation(ast);
        if (lhs_incorrect == true) {
            add_to_console("ERROR [Incorrect assignment]. Assign to variables or arrays",'orange');
        }
        else if (variables_in_iterator.length > 0) {
            add_to_console("ERROR [Unknown variable in iterator: "+variables_in_iterator[0]+"]. Use constants or other iterators",'orange');
        }
        else if (variables_in_array.length > 0) {
            add_to_console("ERROR [Unknown variable in array call: "+variables_in_array[0]+"]. Use constants or iterators",'orange');
        }
        else if (too_deep == 1) {
            add_to_console("ERROR [Dimensionality too large]. Use 1D or 2D loops for option: iteration space",'orange');
        }
        else {
            add_to_console("Simulation done",'green');

            if (iterations_1.length != 0) {
                max_deepness = 1;
                if (iterations_2.length != 0) {
                    max_deepness = 2;
                }
            }

            // GRAPH DECL
            // create an array with nodes
            var nodes = new vis.DataSet([]);

            // create an array with edges
            var edges = new vis.DataSet([]);

            // create a network
            var container = document.getElementById('is_network');

            // provide the data in the vis format
            var data = {
                nodes: nodes,
                edges: edges
            };

            //nodes.on('*', function (event, properties, senderId) {});

            width = window.innerWidth - 650 - 15;

            add_to_console("Building iteration space...");
            if (max_deepness == 1 || max_deepness == 2) {
                spacing = calculate_graph_point();
                current_x = (spacing[0]+spacing[1])/2;
                if (max_deepness == 1) {
                    node_size = 25 < spacing[0]/2 ? 25 : spacing[0]/2;
                    for (i = 0; i < iterations_1.length; i++) {
                        nodes.add({id: iterations_1[i].toString(), label: iterations_1[i][0][1]+"", x: current_x, y: 265, size: node_size});
                        current_x += spacing[0]+spacing[1];
                    }
                }
                else if (max_deepness == 2) {
                    current_y = -(spacing[0][0]+spacing[1][0])/2;
                    if (spacing[0][0] < spacing[0][1]) {
                        node_size = spacing[0][0]/2;
                    }
                    else {
                        node_size = spacing[0][1]/2;
                    }
                    node_size = 25 < node_size ? 25 : node_size;
                    var rows = iterations_2.length/iterations_1.length;

                    for (i = 0; i < iterations_2.length; i++) {
                        if (i % rows == 0) {
                            current_x = (spacing[0][1]+spacing[1][1])/2;
                            current_y += spacing[0][0]+spacing[1][0];
                        }
                        nodes.add({id: iterations_2[i].toString(), label: iterations_2[i][0][1]+","+iterations_2[i][1][1], x: current_x, y: current_y, size: node_size});
                        current_x += spacing[0][1]+spacing[1][1];
                    }
                }
            }

            for (i = 0; i < raw_it.length; i ++) {
                if (!multi.has(raw_it[i].toString())) {
                    edges.add({id: raw_it[i].toString(), from: raw_it[i][0].toString(), to: raw_it[i][1].toString(), label: get_distance(raw_it[i]).toString(),  color: { color: '#FF7C23', highlight: '#FF7C23'}});
                    multi.set(raw_it[i].toString(),1);
                }
            }

            for (i = 0; i < war_it.length; i ++) {
                if (multi.get(war_it[i].toString()) == 1) {
                    edges.update({id: war_it[i].toString(), color: { color: '#B660E8', highlight: '#B660E8'}});
                    multi.set(war_it[i].toString(),10);
                }
                else if (!multi.has(war_it[i].toString())) {
                    edges.add({id: war_it[i].toString(), from: war_it[i][0].toString(), to: war_it[i][1].toString(), label: get_distance(war_it[i]).toString(), color: { color: '#5889FF', highlight: '#5889FF'}});
                    multi.set(war_it[i].toString(),2);
                }
            }

            for (i = 0; i < waw_it.length; i ++) {
                if (multi.get(waw_it[i].toString()) == 1 || multi.get(waw_it[i].toString()) == 2 ) {
                    edges.update({id: waw_it[i].toString(), color: { color: '#B660E8', highlight: '#B660E8'}});
                }
                else if (!multi.has(waw_it[i].toString())) {
                    edges.add({id: waw_it[i].toString(), from: waw_it[i][0].toString(), to: waw_it[i][1].toString(), label: get_distance(waw_it[i]).toString(), color: { color: 'red', highlight: 'red'}});
                }
            }

            var options = {
            width: width+'px',
            height: height+'px',
            nodes: {
                font: {face: 'Arvo', color: 'white', size: Math.floor(node_size*0.9)},
                color: {
                    background: '#888',
                    highlight: 'blue'
                },
                shape: 'circle',
                borderWidth: 0
            },
            edges: {
                font: {face: 'Arvo', color: '#444', size: Math.floor(node_size*0.9)},
                smooth: {
                    type: 'curvedCW',
                    forceDirection: 'none'
                },
                arrows: {
                    to: {
                        enabled: true
                    }
                },
                color: {
                    color: '#333',
                    highlight: 'red'
                }
            },
            physics: false,
            interaction: {
                dragNodes: false,
                zoomView: false,
                dragView: false
            }
            };

            network = new vis.Network(container, data, options);
            network.moveTo({
            position: {x: 0, y: 0},
            offset: {x: -Math.floor(width*0.9/2), y: -Math.floor(height*0.9/2)},
            scale: 1,
            })

            //document.getElementById('direction_vector').innerHTML = "["+direction+"]";
            add_to_console("Done",'green');
        }
    }
}

// DEPENDENCY GRAPH
function make_dependency_graph() {
    add_to_console("Running simulation with option: depdency graph...",'#c7c7c7');
    option = 2;
    $("#DependencyGraph").animate({ scrollTop: 0 }, "fast");

    // REFRESH ...

    iterators = new Map();
    reads = new Map();
    writes = new Map();
    reads_it = new Map();
    writes_it = new Map();
    current_stmt = 0;
    variables_in_array = new Array();
    variables_in_iterator = new Array();
    iterations_1 = new Array();
    iterations_2 = new Array();
    stop_the_program = false;
    clean = false;
    known_vars = new Map();
    lhs_incorrect = false;

    raw = new Array();
    war = new Array();
    waw = new Array();
    raw_it = new Array();
    war_it = new Array();
    waw_it = new Array();
    raw_map = new Map();
    war_map = new Map();
    waw_map = new Map();

    // HELP
    var cnt = 1;
    var graph_links = new Map();
    var multi = new Map();
    var deepness = 0;
    var max_deepness = 0;
    var edges_added = new Map();
    height = 350;

    document.getElementById('dg_network').innerHTML = "";

    run_simulation(ast);
    if (lhs_incorrect == true) {
        add_to_console("ERROR [Incorrect assignment]. Assign to variables or arrays",'orange');
    }
    else if (variables_in_iterator.length > 0) {
        add_to_console("ERROR [Unknown variable in iterator: "+variables_in_iterator[0]+"]. Use constants or other iterators",'orange');
    }
    else if (variables_in_array.length > 0) {
        add_to_console("ERROR [Unknown variable in array call: "+variables_in_array[0]+"]. Use constants or iterators",'orange');
    }
    else {
        add_to_console("Simulation done",'green');

        // GRAPH DECL
        // create an array with nodes
        var nodes = new vis.DataSet([]);

        // create an array with edges
        var edges = new vis.DataSet([]);

        // create a network
        var container = document.getElementById('dg_network');

        // provide the data in the vis format
        var data = {
            nodes: nodes,
            edges: edges
        };

        //nodes.on('*', function (event, properties, senderId) {});

        var width = window.innerWidth - 650 - 15;

        add_to_console("Building dependency graph...");
        for (i = 1; i <= ast.stmt_nr; i++) {
            if (stmt_register.length == 0 || stmt_register.has(i)) {
                nodes.add({id: i, label: "S"+i.toString()});
            }
        }
        for (i = 0; i < raw.length; i++) {
            if (edges_added.has(raw[i][0]+","+raw[i][1])) {
                var new_delta = edges_added.get(raw[i][0]+","+raw[i][1])+","+get_delta(raw[i][2],'raw');
                edges.update({id: raw[i][0]+","+raw[i][1], from: raw[i][0], to: raw[i][1], label: new_delta});
                edges_added.set(raw[i][0]+","+raw[i][1],new_delta);
            }
            else {
                var new_delta = get_delta(raw[i][2],'raw');
                edges.add({id: raw[i][0]+","+raw[i][1], from: raw[i][0], to: raw[i][1], label: new_delta });
                edges_added.set(raw[i][0]+","+raw[i][1],new_delta);
            }
        }

        for (i = 0; i < war.length; i++) {
            if (edges_added.has(war[i][0]+","+war[i][1])) {
                var new_delta = edges_added.get(war[i][0]+","+war[i][1])+","+get_delta(war[i][2],'war');
                edges.update({id: war[i][0]+","+war[i][1], from: war[i][0], to: war[i][1], label: new_delta});
                edges_added.set(war[i][0]+","+war[i][1],new_delta);
            }
            else {
                var new_delta = get_delta(war[i][2],'war');
                edges.add({id: war[i][0]+","+war[i][1], from: war[i][0], to: war[i][1], label: new_delta });
                edges_added.set(war[i][0]+","+war[i][1],new_delta);
            }
        }

        for (i = 0; i < waw.length; i++) {
            if (edges_added.has(waw[i][0]+","+waw[i][1])) {
                var new_delta = edges_added.get(waw[i][0]+","+waw[i][1])+","+get_delta(waw[i][2],'waw');
                edges.update({id: waw[i][0]+","+waw[i][1], from: waw[i][0], to: waw[i][1], label: new_delta});
                edges_added.set(waw[i][0]+","+waw[i][1],new_delta);
            }
            else {
                var new_delta = get_delta(waw[i][2],'waw');
                edges.add({id: waw[i][0]+","+waw[i][1], from: waw[i][0], to: waw[i][1], label: new_delta });
                edges_added.set(waw[i][0]+","+waw[i][1],new_delta);
            }
        }

        var options = {
            width: width+'px',
            height: height+'px',
            nodes: {
                font: {face: 'Arvo', color: 'white', size: 30},
                color: {
                    background: '#888',
                    highlight: 'blue',
                },
                margin:10,
                shape: 'circle',
                borderWidth: 0,
            },
            edges: {
                font: {face: 'Arvo', color: '#444', size: 25},
                smooth: {
                    type: 'curvedCW',
                    forceDirection: 'none'
                },
                arrows: {
                    to: {
                        enabled: true
                    }
                },
                color: {
                    color: '#666',
                    highlight: 'red'
                }
            },
            physics: true,
            interaction: {
                dragNodes: true,
                zoomView: false,
                dragView: false
            }
            };

        network = new vis.Network(container, data, options);

        add_to_console("Done",'green');
    }
}

// Subscript classes and functions

class Subscript {
    constructor() {
        this.elems = new Array();
        this.vars = new Set();
    }
    add(single_sub) {
        this.elems.push(single_sub);
        this.vars = this.vars.union(single_sub.vars);
    }
    put_index(index) {
        this.index = index;
    }
}

class SingleSub {
    constructor(expr,str) {
        this.expr = expr;
        this.str = str;
        this.vars = get_vars_in(expr);
    }
}

class Partition {
    constructor(subscript) {
        this.subscripts = new Array(subscript);
        this.vars = subscript.vars;
    }
    add(partition) {
        for (var i = 0; i < partition.subscripts.length; i ++) {
            this.subscripts.push(partition.subscripts[i]);
        }
        this.vars = this.vars.union(partition.vars);
    }
    classify(its) {
        if (this.subscripts.length > 1) return "coupled";
        else {
            var subscript = this.subscripts[0];
            var cnt = 0;
            for (var i = 0; i < its.length; i++) {
                if (subscript.vars.has(its[i])) cnt ++;
            }
            if (cnt == 0) return "ziv";
            else if (cnt == 1) return "siv";
            else return "miv";
        }
    }
}

function make_subscripts (list) {
    var subscripts = new Array();
    for (var i = 0; i < list[0].index_list.length; i ++) {
        var subscript = new Subscript();
        for (var j = 0; j < list.length; j ++) {
            subscript.add(new SingleSub(list[j].index_list[i],list[j].index_text[i]));
        }
        subscript.put_index(i);
        subscripts.push(subscript);
    } 
    return subscripts;
}

function get_vars_in (expr) {
    if (expr.type == 'var') {
        return new Set([expr.variable]);
    }
    else if (expr.type == 'op') {
        if (expr.lhs == null) {
            return get_vars_in(expr.rhs);
        }
        else {
            return get_vars_in(expr.rhs).union(get_vars_in(expr.lhs));
        }
    }
    return new Set();
}

function get_selected_arrs() {
    var i;
    var arrs = new Array();
    var wrs = writes_selected.entriesArray();
    var rds = reads_selected.entriesArray();
    for (i = 0; i < wrs.length; i ++) {
        arrs.push(writes_enum.get(wrs[i][0]));
    }
    for (i = 0; i < rds.length; i ++) {
        arrs.push(reads_enum.get(rds[i][0]));
    }
    return arrs;
}

function check_all(arr_list) { // id, dimension, iterators at, and returns iterators
    if (arr_list.length == 0) return -1;
    var i;
    var id = arr_list[0].id;
    var dimension = arr_list[0].index_list.length;
    var iterators_at = arr_list[0].iterators_at.toString();
    for (i = 1; i < arr_list.length; i++) {
        if (arr_list[i].id != id) return -2;
        if (arr_list[i].index_list.length != dimension ) return -3;
        if (arr_list[i].iterators_at.toString() != iterators_at) return -4;
    }
    var its = new Array();
    for (i = 0; i < arr_list[0].iterators_at.length; i++) {
        its.push(arr_list[0].iterators_at[i][0]);
    }
    return its;
}

function subscript_partition(subscripts,its) {
    var i, j, k;
    var partitions = new Array();
    for (i = 0; i < subscripts.length; i ++) {
        partitions.push(new Partition(subscripts[i]));
    }
    for (i = 0; i < its.length; i ++) {
        var k = -1;
        for (j = 0; j < partitions.length; j ++) {
            if (partitions[j].vars.has(its[i])) {
                if (k == -1) k = j;
                else {
                    partitions[k].add(partitions[j]);
                    partitions.splice(j,1);
                }
            }
        }
    }
    return partitions;
}

// GLOBALS FOR SUBSCRIPT TESTS

var arrs;
var its;
var subscripts;
var partitions;
var id = 0;
var miv_button = [];
var total = 0;

var classname = document.getElementsByClassName("refresh");

Array.from(classname).forEach(function(element) {
      element.addEventListener('click', refresh);
    });

function refresh() {
    document.getElementById('arrs').innerHTML = "...";
    document.getElementById('subscripts').innerHTML = "...";
    document.getElementById('partitions').innerHTML = "...";
    document.getElementById("st_step_select").style = "display:block;";
    document.getElementById('st_step_part').style = "display:none;"
    document.getElementById('st_step_subscr').style = "display:none;"
    document.getElementById('holder3').style = "display:inline-block;";
    document.getElementById('holder3_refresh').style = "display:none;";
    document.getElementById('parttabs').innerHTML = "";
    document.getElementById('parttabs').style = "display:none;"
    id = 0;
    miv_button = [];
    total = 0;
}

/*document.getElementsByClassName("refresh").addEventListener('click', function(event) {
    document.getElementById('arrs').innerHTML = "";
    document.getElementById('subscripts').innerHTML = "";
    document.getElementById('partitions').innerHTML = "";
    document.getElementById("st_step_select").style = "display:block;";
    document.getElementById('st_step_part').style = "display:none;"
    document.getElementById('st_step_subscr').style = "display:none;"
    document.getElementById('holder3').style = "display:inline-block;";
    id = 0;
});*/

document.getElementById("st_select").addEventListener('click', function(event) {
    var i , j ;

    arrs = get_selected_arrs();
    if (arrs.length == 2) {
        its = check_all(arrs);

        if (arrs[0].id != arrs[1].id) {
            alert("Please select calls that refer to the same array.");
        }
        else if (arrs[0].index_text.length != arrs[1].index_text.length) {
            alert("Please select array calls that have the same dimension. There might be something wrong with your program.")
        }
        else {
            document.getElementById("st_step_subscr").style = "display:block";
            document.getElementById("st_step_select").style = "display:none;";
            document.getElementById("holder1").style = "display:inline-block;"

            var text = "";
            for (i = 0; i < arrs.length; i ++) {
                text += '<span class = "arr">'+arrs[i].id+'[';
                for (j = 0; j < arrs[i].index_text.length; j ++) {
                    text += arrs[i].index_text[j] + ",";
                }
                text = text.substring(0,text.length-1) + ']</span>';
            }

            document.getElementById("arrs").innerHTML = text;
        }
    }
    else {
        alert("Please select 2 array calls from the left-hand side visualizer of the input code. Parse your code first.");
    }
});

document.getElementById("st_subscr").addEventListener('click', function(event) {

    var i , j ;
    document.getElementById("st_step_subscr").style = "display:none;";
    document.getElementById("st_step_part").style = "display:block;"
    document.getElementById("holder2").style = "display:inline-block;"
    

    subscripts = make_subscripts(arrs);
    var subscripts_div = document.getElementById("subscripts");
    subscripts_div.innerHTML = "";

    for (i = 0; i < subscripts.length; i ++) {
        var text_form = "&lt;";
        for (j = 0; j < subscripts[i].elems.length; j ++) {
            text_form += subscripts[i].elems[j].str + ",";
        }
        text_form = text_form.substring(0,text_form.length-1) + "&gt";

        var subscript = document.createElement('div');
        subscript.className = "subscript";
        subscript.innerHTML = '<span class="actual_subscript">'+text_form+'</span>';
        //subscript.innerHTML = '<span class="subscript_nr">'+subscripts[i].index+'</span><span class="actual_subscript">'+text_form+'</span>';
        subscripts_div.appendChild(subscript);
    }
});

document.getElementById("st_part").addEventListener('click', function(event) {
    document.getElementById("st_step_part").style = "display:none";
    var part_tabs = document.getElementById("parttabs");
    part_tabs.style="display:block;";
    document.getElementById("holder3").style = "display:block;"
    document.getElementById("holder3_refresh").style = "display:block; z-index:1; position:absolute; top:84px; left: 1140px;"
    var i = 0;
    partitions = subscript_partition(subscripts,its);

    var partitions_div = document.getElementById('partitions');
    partitions_div.innerHTML = "";
    for (i = 0; i < partitions.length; i ++) {
        total = i;
        text_form = "{";
        var forms = new Array();
        for (var j = 0; j < partitions[i].subscripts.length; j ++) {
            text_form += '<div class="subscript"><span class="actual_subscript">';
            //text_form += '<div class="subscript"><span class="subscript_nr">'+partitions[i].subscripts[j].index+'</span><span class="actual_subscript">';
            text_form += "&lt;";
            for (var k = 0; k < partitions[i].subscripts[j].elems.length; k ++) {
                text_form += partitions[i].subscripts[j].elems[k].str + ",";
                var arrs = new Array();
                forms.push(get_form(partitions[i].subscripts[j].elems[k].expr));
            }
            text_form = text_form.substring(0,text_form.length-1) + "&gt";
            text_form += '</span></div>,';
        }
        partitions[i].forms = forms;
        text_form = text_form.substring(0,text_form.length-1) + "}";
        var partition = document.createElement('div');
        partition.className = "partition";
        partitions[i].index = i;
        partition.innerHTML = '<button id = "partbutton_'+i+'" class="parttab_button" onclick="openTabPart(event, \'parttab'+i+'\')"><div class="actual_partition">'+text_form+'</div></button>';
        var tab = document.createElement('div');
        tab.className = "parttab";
        tab.id = "parttab"+i;
        tab.style="display:none;"
        var classify_div = document.createElement('div');
        classify_div.id = "update1_"+i;
        tab.appendChild(classify_div);
        classify_div.innerHTML = '<span>Classify partition <span style="font-weight:700; color:red; margin: 0 5px; text-shadow: #fff 0 1px 0;">'+text_form+'</span> into:</span>';
        var classify_div_remove = document.createElement('div');
        classify_div_remove.style="margin:10px 0 0 15px; line-height:20px;";
        classify_div_remove.innerHTML = '<ul style=\"margin-bottom:10px;\"><li style="margin-bottom:5px;"><b>ZIV</b> - A subscript is said to be ZIV (zero index variable) if the subscript position contains no index in either reference</li><li style="margin-bottom:5px;"><b>SIV</b> - A subscript is said to be SIV (single index variable) if only one index occurs in that position</li><li style="margin-bottom:5px;"><b>MIV</b> - Any subscript with more than one index is said to be MIV (multiple index variable)</li><li><b>COUPLED</b> - If two different subscripts contain the same index, they are coupled.</li></ul>';
        classify_div_remove.id="remove1_"+i;
        tab.appendChild(classify_div_remove);

        var continue_div = document.createElement('div');
        continue_div.id = "continue_div"+i;
        var continue_div_1 = document.createElement('span');
        var continue_div_2 = document.createElement('span');
        continue_div_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"continue_div"+i+"_span\" class=\"cont_1\" onclick=\"classifyThis(event,"+i+")\">Classification:</span>"
        continue_div_2.innerHTML = "..."
        tab.appendChild(continue_div);
        continue_div.appendChild(continue_div_1);
        continue_div_1.id="continue_div"+i+"_1";
        continue_div_2.id="continue_div"+i+"_2";
        continue_div.appendChild(continue_div_2);
        part_tabs.append(tab);

        //



        /*partition.innerHTML = '<div class="actual_partition">'+text_form+'</div><div class="classification">'+partitions[i].classify(its)+'</div>';
        if (partitions[i].classify(its) == 'siv') {
            var form = siv_form(forms);
            if (form[0] == 'strong') {
                strong_siv(form);
            }
            //partition.innerHTML += '<div class="classification">'+siv_form(forms)+'</div>';
        }*/
        partitions_div.appendChild(partition);
    }
    var part_status_whole = document.createElement('div');
    var part_status_upper = document.createElement('div');
    var part_status = document.createElement('div');
    part_status_whole.appendChild(part_status_upper);
    part_status_whole.appendChild(part_status);
    part_status_upper.innerHTML = "STATUS";
    part_status_upper.className = "part_status_upper";
    part_status.innerHTML = "Tests not done";
    part_status.id = "part_status";
    part_status_whole.style = "display:inline-block; margin-left:10px; width-max:300px;";
    partitions_div.appendChild(part_status_whole);
});

function classifyThis(event, i) {
    var p = partitions[i];
    var classification = p.classify(its);
    var continue_div_2 = document.getElementById("continue_div"+i+"_2");
    var continue_div_1 = document.getElementById("continue_div"+i+"_1");
    continue_div_2.innerHTML = classification;
    continue_div_2.style="font-size:20px; text-transform:uppercase; font-weight:700; color:red; text-shadow: #fff 0 1px 0;"
    continue_div_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"continue_div"+i+"_span\" class=\"cont_1_clicked\">Classification:</span>"
    var class_div = document.createElement('div');
    class_div.id="class_div"+i;
    var remove1 = document.getElementById("remove1_"+i);
    remove1.style="display:none;";
    var update1 = document.getElementById("update1_"+i);
    update1.innerHTML += ' <div class="vis_ziv" style="display:inline-block; text-decoration:underline; color:blue; margin:0 3px;"><B>ZIV</B></div>, <div class="vis_siv" style="display:inline-block; text-decoration:underline; color:blue; margin: 0 3px;"><B>SIV</B></div>, <div class="vis_miv" style="display:inline-block; text-decoration:underline; color:blue; margin: 0 3px;"><B>MIV</B></div> or <div class="vis_coupled" style="display:inline-block; text-decoration:underline; color:blue; margin: 0 3px;"><b>COUPLED</b></div>.';
    if (classification == 'siv') {
        put_info('siv');
        var determine_div = document.createElement("div");
        class_div.appendChild(determine_div);
        var update2 = document.createElement('div');
        update2.id ="update2_"+i;
        determine_div.appendChild(update2);
        update2.innerHTML = "<div>Determine the type of the SIV based on its form:</div>";
        var determine_remove = document.createElement('div');
        determine_remove.id="remove2_"+i;
        determine_div.appendChild(determine_remove);
        determine_remove.innerHTML = "<ul style=\"margin-bottom:10px;\"><li style=\margin-bottom:5px;\"><B>STRONG</B> <span style=\margin: 0 10px;\">-</span> <$a*i+c_1,a*i+c_2$>  (the coefficients of the two occurrences of the index i are constant and equal)</li><li style=\margin-bottom:5px;\"><B>WEAK</B> <span style=\margin: 0 10px;\">-</span> <$a_1*i+c_1,a_2*i+c_2$> (differing coefficients on the loop induction variable)</li><li style=\margin-bottom:5px;\"><B>WEAK-ZERO</B> <span style=\margin: 0 10px;\">-</span> <$c_1,a_2*i+c_2$> <span style=\"margin: 0 5px;\">or</span> <$a_1*i+c_1,c_2$> (if one of the two coefficients is $0$ : i.e., $a_1 = 0$ or $a_2 = 0$)</li><li><B>WEAK-CROSSING</B> <span style=\margin: 0 10px;\">-</span> <$a*i+c_1,-a*i+c_2$></li></ul> where $i$ - loop index, $a$ - single index coefficient, $a_1$/$a_2$ - index coefficients, $c_1$/$c_2$ - loop invariant terms.";
        determine_div.style="margin-top:10px;";
        determine_div.id="determine_div"+i;
        var determine_div_1 = document.createElement('span');
        var determine_div_2 = document.createElement('span');
        determine_div_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"determine_div"+i+"_span\" class=\"cont_1\" onclick=\"sivTypeThis(event,"+i+")\">SIV Type:</span>";
        determine_div_2.innerHTML = "...";
        determine_div_1.id="determine_div"+i+"_1";
        determine_div_2.id="determine_div"+i+"_2";
        determine_div.appendChild(determine_div_1);
        determine_div.appendChild(determine_div_2);
    }
    else if (classification == 'ziv') {
        put_info('ziv');
        var about_ziv= document.createElement("div");
        about_ziv.style = "margin-top:10px;"
        about_ziv.innerHTML = "Since ZIV subscripts contain no references to any loop induction variables, they do not vary within any loop (assuming all symbolic terms are loop invariant). Thus, if the two expressions can be proved not to be equal, then the corresponding array references are independent. If the expressions cannot be shown to be different, then the subscript does not contribute to any direction vector (since it contains no loop induction variable), and may be ignored.";
        var forms = partitions[i].forms;
        var diff = get_form_add(forms[0],get_form_mult(forms[1],new Array(new Value(-1))));
        get_form_mult(forms[1],new Array(new Value(-1)));
        //forms[1] = get_form_mult(forms[1],new Array(new Value(-1)));
        var indep = 'undecided';
        var do_ziv = document.createElement('div');
        do_ziv.style="margin-top:10px;";
        do_ziv.innerHTML = "$"+display_form(forms[0],false)+" = "+display_form(forms[1],false)+"$ ";
        if (diff.length == 1) {
            if (diff[0].type == 'val') {
                if (diff[0].value == 0) {
                    indep = 'true';
                }
                else {
                    indep = 'false';
                }
            }
        }
        if (indep == 'true') {
            do_ziv.innerHTML += '<span style="margin:0 5px 0 10px; color:green;"><b>True</b></span> => test does not yield independence.';
            document.getElementById("partbutton_"+i).classList.add('parttab_button_red');
        }
        else if (indep == 'false') {
            do_ziv.innerHTML += '<span style="margin:0 5px 0 10px; color:red;"><b>False</b></span> => test yields independence.';
            document.getElementById("partbutton_"+i).classList.add('parttab_button_green');
        }
        else {
            do_ziv.innerHTML += '<span style="margin:0 5px 0 10px; color:orange;"><b>Unknown</b></span> => cannot determine independence.';
            document.getElementById("partbutton_"+i).classList.add('parttab_button_orange');
        }
        class_div.appendChild(about_ziv);
        class_div.appendChild(do_ziv);
        arrive_at('ziv',document.getElementById("partbutton_"+i));
        overall_dep();
    }
    else if (classification == 'miv') {
        put_info('miv');
        miv_button[i] = 'grey';
        var about_miv = document.createElement('div');
        about_miv.style = "margin-top:10px;";
        about_miv.innerHTML = 'A MIV (multiple variable index) means there are multiple loop indexes in the subscript. Determining whether there is a dependence is equivalent to determining whether there exists an integer solution to the equation system: <p>$f(x_1,x_2,...,x_n) = g(y_1,y_2,...,y_n)$ in the space defined by: $L_i \\le x_i, y_i \\le Ui, ∀i, 1 \\le i \\le n$</p> Let R denote the region defined in the previous equations. Then the equation has a solution if: <p>$h(x_1,x_2,...,x_n,y_1,y_2,...,y_n) = f(x_1,x_2,...,x_n) – g(y_1,y_2,...,y_n) = 0$</p> has an integer solution somewhere inside the region R. Since integer solutions are required, this problem lies in the theory of Diophantine equations. Searching for real solutions (or, more precisely, the absence of real solutions) to the equation in the region R is useful. If the equation does not have a real solution, then it cannot have an integer solution, and accordingly, no dependence can exist. Assume for the moment that the functions f and g are continuous in the region R. The following theorem follows directly from elementary analysis: If f and g are continuous functions on region R, there exists a real solution to equation if and only if: <p>$min_R h \\le 0 \\le max_R h$ (Immediate from the Intermediate Value Theorem)</p> Assuming f and g are affine functions, they have the form: $f(x_1,x_2,...,x_n) = a_0 + a_1 x_1 + ... + a_n x_n$ and $g(y_1,y_2,...,y_n) = b_0 + b_1 y_1 + ... + b_n y_n$ , then the dependence problem to be solved is to find solutions in the region R to the linear diophantine equation: <p>$a_0 – b_0 + a_1 x_1 – b_1 y_1 + ... + a_n x_n – b_n y_n = 0$ <p>Two tests for proving independence are presented:</p>';
        class_div.appendChild(about_miv);
        var about_gcd = document.createElement('div');
        var about_banerjee = document.createElement('div');
        about_gcd.innerHTML = '<div style="font-size:18px; color:#444;"><b>GCD Test</b></div><p>Rearranging the terms of the linear diophantine equation yields the following:<p>$a_1 x_1 – b_1 y_1 + ... + a_n x_n - b_n y_n = b_0 – a_0$</p>which is the standard form for a linear diophantine equation. A fundamental theorem about these equations is the following: The equation has a solution if and only if $gcd(a1,...,an,b1,...,bn)$ divides $b_0 – a_0$. Thus, if the gcd of all the coefficients of loop induction variables does not divide the difference of the two constant additive terms, there can be no solution to the equation anywhere-hence, no dependence can exist. On the other hand, if the gcd of the coefficients does divide $b_0 – a_0$, there is a solution somewhere, although it need not be in the region of interest R.</p>';
        about_gcd.style="margin-top:25px;"
        about_banerjee.innerHTML = '<div style="font-size:18px; color:#444;"><b>Banerjee Test</b></div><p>We can test for a real solution to the diophantine equation presented previously. Constraining: <p>$h(f(x_1,x_2,..,x_n),g(y_1,y_2,..,y_n)) = a_1 x_1 + a_2 x_2 + .. + a_n + a_0 - b_1 y_1 - b_2 y_2 - .. - b_n y_n - b_0 = 0$</p> we can test if h ever becomes 0 in the region, which implies equality. And by the Intermediate value theorem if $max_R h \\ge 0$ and $min_R h \\le 0$, then this is true.</p> To calculate the minimum, substitute each index from f with its lower bound and each index from g with its upper bound. And to calculate the minimum, substitute each index from f with is upper bound and each index from g with its lower bound.';
        about_banerjee.style="margin-top:25px;"

        var gcd_test = document.createElement('div');
        gcd_test.id="gcd_test_"+i;
        var banerjee_test = document.createElement('div');
        banerjee_test.id="banerjee_test_"+i;
        gcd_test.style="margin-top:-10px;";

        var gcd_test_1 = document.createElement('span');
        var gcd_test_2 = document.createElement('span');
        var banerjee_test_1 = document.createElement('span');
        var banerjee_test_2 = document.createElement('span');

        gcd_test_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"gcd_test_"+i+"_span\" class=\"cont_1\" onclick=\"mivGCD(event,"+i+")\">GCD Test:</span>";
        gcd_test_2.innerHTML = "...";

        banerjee_test_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"banerjee_test_"+i+"_span\" class=\"cont_1\" onclick=\"mivBanerjee(event,"+i+")\">Banerjee Test:</span>";
        banerjee_test_2.innerHTML = "...";

        gcd_test_1.id="gcd_test_1_"+i;
        gcd_test_2.id="gcd_test_2_"+i;

        banerjee_test_1.id="banerjee_test_1_"+i;
        banerjee_test_2.id="banerjee_test_2_"+i;

        gcd_test.appendChild(gcd_test_1);
        gcd_test.appendChild(gcd_test_2);

        banerjee_test.appendChild(banerjee_test_1);
        banerjee_test.appendChild(banerjee_test_2);

        class_div.appendChild(about_gcd);
        class_div.append(gcd_test);
        class_div.appendChild(about_banerjee);
        class_div.append(banerjee_test);
  
        
        /*forms = partitions[i].forms;
        mivs = miv_test(forms[0],forms[1]);
        console.log(mivs);
        miv_gcds = miv_gcd(mivs[1],mivs[2],mivs[3]);
        console.log(miv_gcds);
        bnj = banerjee(forms[0],forms[1]);
        console.log(bnj);*/

    }
    else if (classification == 'coupled') {
        put_info('coupled');
        forms = p.forms;
        /////////////// info about coupled
        var about_coupled = document.createElement('div');
        about_coupled.innerHTML = 'The tests used for separable subscripts can also be used on each subscript of a coupled group—if any test proves independence, then no dependence exists. The separated subscripts and their respective tests can be found below:';
        about_coupled.style="margin: 10px 0;";
        class_div.append(about_coupled);
        for (var j = 0; j < forms.length; j=j+2) {
            total++;
            text_form = '&lt'+display_form(forms[j],false)+","+display_form(forms[j+1],false)+'&gt';
            partitions[total] = new Partition(p.subscripts[j/2]);
            partitions[total].forms = [forms[j],forms[j+1]];
            var partition = document.createElement('div');
            partition.innerHTML = '<button id = "partbutton_'+total+'">x</button>';
            partition.style="display:none;";
            class_div.append(partition);
            /*var partition = document.createElement('div');
            partition.className = "partition";
            partition.innerHTML = '<button id = "partbutton_'+total+'" class="tabcoupled_button" onclick="openTabCoupled(event, \'parttab'+total+'\')"><div class="actual_partition">'+text_form+'</div></button>';
            class_div.appendChild(partition);*/
            var ctab = document.createElement('div');
            ctab.className = "tabcoupled";
            ctab.id = "parttab"+total;
            ctab.style="margin-bottom:50px;";
            var classify_div = document.createElement('div');
            classify_div.id = "update1_"+total;
            ctab.appendChild(classify_div);
            classify_div.innerHTML = '<span>Classify subscript <span style="font-weight:700; color:red; font-size:18px; margin: 0 5px; text-shadow: #fff 0 1px 0;">'+text_form+'</span> into:</span>';
            var classify_div_remove = document.createElement('div');
            classify_div_remove.style="margin:10px 0 0 15px; line-height:20px;";
            classify_div_remove.innerHTML = '<ul style=\"margin-bottom:10px;\"><li style="margin-bottom:5px;"><b>ZIV</b> - A subscript is said to be ZIV (zero index variable) if the subscript position contains no index in either reference</li><li style="margin-bottom:5px;"><b>SIV</b> - A subscript is said to be SIV (single index variable) if only one index occurs in that position</li><li style="margin-bottom:5px;"><b>MIV</b> - Any subscript with more than one index is said to be MIV (multiple index variable)</li></ul>';
            classify_div_remove.id="remove1_"+total;
            ctab.appendChild(classify_div_remove);

            var continue_div = document.createElement('div');
            continue_div.id = "continue_div"+total;
            var continue_div_1 = document.createElement('span');
            var continue_div_2 = document.createElement('span');
            continue_div_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"continue_div"+total+"_span\" class=\"cont_1\" onclick=\"classifyThis(event,"+total+")\">Classification:</span>"
            continue_div_2.innerHTML = "..."
            ctab.appendChild(continue_div);
            continue_div.appendChild(continue_div_1);
            continue_div_1.id="continue_div"+total+"_1";
            continue_div_2.id="continue_div"+total+"_2";
            continue_div.appendChild(continue_div_2);
            class_div.append(ctab);
        }
        var about_delta = document.createElement('div');
        class_div.append(about_delta);
        about_delta.innerHTML = 'A slightly stronger approach to subscript-by-subscript testing is to test each subscript separately and intersect the resulting sets of direction vectors. Example: <div style="font-family:\'Courier New\', Courier, monospace; margin: 20px 0;"><div style="margin-left:20px;">DO I = 1, 100</div><div style="margin-left:40px;">A(I+1,I) = B(I) + C</div><div style="margin-left:40px;">D(I) = A(I,I) * E</div><div style="margin-left:20px;">ENDDO</div></div>Here, testing the first subscript yields the direction vector (<), while testing in the second position yields the direction vector (=). When we intersect these directions, we discover that no dependence can exist. This method permits simple and efficient testing, but in some cases also provides a conservative approximation to the set of directions within a coupled group. That is, it may yield direction vectors that do not exist. For instance, consider the following loop:<div style="font-family:\'Courier New\', Courier, monospace; margin: 20px 0;"><div style="margin-left:20px;">DO I = 1, 100</div><div style="margin-left:40px;">A(I+1, I+2) = A(I, I) + C</div><div style="margin-left:20px;">ENDDO</div></div>Subscript-by-subscript test with direction vector intersection would yield the single direction vector (<,<). However, a careful examination of the statement reveals that this direction vector is invalid, because no dependence actually exists—the subscript pairs cannot be simultaneously equal. To address this problem we can strengthen the dependence test to intersect distance vectors rather than direction vectors. When the SIV test is applied to the above example, the two subscripts produce two different distance vectors: (1) and (2). The intersection of these distance vectors is clearly empty. This strategy is extremely effective because such a large percentage of the dependence tests applied in practice are strong SIV tests, which produce distances.';
        // more info about coupled
    }
    var tab = document.getElementById("parttab"+i);
    tab.appendChild(class_div);
    $('.vis_ziv').each(function() {
         $(this).qtip({
             content: {
                 text: 'A subscript is said to be ZIV (zero index variable) if the subscript position contains no index in either reference.' },
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
     $('.vis_siv').each(function() {
         $(this).qtip({
             content: {
                 text: 'A subscript is said to be SIV (single index variable) if only one index occurs in that position.'},
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
     $('.vis_miv').each(function() {
         $(this).qtip({
             content: {
                 text: 'Any subscript with more than one index is said to be MIV (multiple index variable).'},
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
     $('.vis_coupled').each(function() {
         $(this).qtip({
             content: {
                text: 'If two different subscripts contain the same index, they are coupled.'},
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}

function mivGCD(event, i) {
    var forms = partitions[i].forms;
    var gcd_test = document.getElementById('gcd_test_'+i);
    var gcd_test_1 = document.getElementById('gcd_test_1_'+i);
    var gcd_test_2 = document.getElementById('gcd_test_2_'+i);
    gcd_test_1.innerHTML =  "<div class=\"continue_icon\">j</div> <span id=\"gcd_test"+i+"_span\" class=\"cont_1_clicked\">GCD Test:</span>";
    var needed = miv_test(forms[0],forms[1]);
    display_coeffs = "";
    all_positive = true;
    all_negative = true;
    disp1 = display_form(needed[2],false);
    disp2 = display_form(needed[3],false);
    for (var j = 0; j < needed[1].length; j ++) {
        display_coeffs += display_form(needed[1][j],false) + ",";
        if (needed[1][j].type == 'val') {
            if (needed[1][j].value < 0) {
                all_positive = false;
            }
            else {
                all_negative = false;
            }
        }
    }
    var gcd = miv_gcd(needed[1],needed[2],needed[3]);
    display_coeffs = display_coeffs.substring(0,display_coeffs.length-1);

    var first_line = document.createElement('div');
    first_line.style="margin-top:10px;";
    gcd_test.appendChild(first_line);

    if (gcd[0] == 'not_possible') {
        first_line.innerHTML = "The greatest common divisior $gcd("+display_coeffs+")$ cannot be computed due to unknown variables in the coefficients of indexes.";
        gcd_test_2.innerHTML = '<span style="color:orange;"><b>Cannot determine</b></span>';
        update_button('orange',i);
    }
    else if (!all_positive && !all_negative) {
        first_line.innerHTML = "The greatest common divisior $gcd("+display_coeffs+")$ cannot be computed due to negative coefficients (testable if all negative or positive).";
        gcd_test_2.innerHTML = '<span style="color:orange;"><b>Cannot determine</b></span>';
        update_button('orange',i);
    }
    else if (gcd[3] == 1 || gcd[3] == -1) {
        first_line.innerHTML = "The greatest common divisior $gcd("+display_coeffs+") = 1$ which divides everything; cannot say anything relevant about dependence.";
        gcd_test_2.innerHTML = '<span style="color:orange;"><b>Cannot determine</b></span>';
        update_button('orange',i);
    }
    else if (gcd[0] == 'sort_of') {
        first_line.innerHTML = "The greatest common divisior $gcd("+display_coeffs+") = "+gcd[3]+"$.";
        var second_line = document.createElement('div');
        first_line.appendChild(second_line);
        second_line.style="margin-top:10px;";
        if (gcd[1].length == 1) {
            if (gcd[1][0].type == 'val') {
                if (Number.isInteger(gcd[1][0].value)) {
                    second_line.innerHTML = '$b_0 – a_0 = '+display_form(gcd[2],false)+'$ and the test is $\\frac{b_0–a_0}{gcd('+display_coeffs+')} = \\frac{'+display_form(gcd[2],false)+'}{'+gcd[3]+'} = '+gcd[1][0].value+'$ is an integer ($<=>$ fraction divisible), therefore the test does not yield independence.';
                    gcd_test_2.innerHTML = '<span style="color:red;"><b>Test does not yield independence</b></span>';
                    update_button('red',i);
                }
                else {
                    second_line.innerHTML = '$b_0 – a_0 = '+display_form(gcd[2],false)+'$ and the test is $\\frac{b_0–a_0}{gcd('+display_coeffs+')} = \\frac{'+display_form(gcd[2],false)+'}{'+gcd[3]+'} = '+gcd[1][0].value+'$ is not an integer ($<=>$ fraction not divisible), therefore the test yields independence.';
                    gcd_test_2.innerHTML = '<span style="color:green;"><b>Test yields independence</b></span>';
                    update_button('green',i);
                }
            }
            else {
                second_line.innerHTML = '$b_0 – a_0 = '+disp2+' - (' +disp1+ ')$ and the test is $\\frac{b_0–a_0}{gcd('+display_coeffs+')} = '+display_form(gcd[2],false)+'$ has unknown variables, cannot test to yield dependence.';
                gcd_test_2.innerHTML = '<span style="color:orange;"><b>Cannot determine</b></span>';
                update_button('orange',i);
            }
        }
        else {
            update_button('orange',i);
            second_line.innerHTML = '$b_0 – a_0 = '+disp2+' - (' +disp1+ ')$ and the test is $\\frac{b_0–a_0}{gcd('+display_coeffs+')} = '+display_form(gcd[2],false)+'$ has unknown variables, cannot test to yield dependence.';
            gcd_test_2.innerHTML = '<span style="color:orange;"><b>Cannot determine</b></span>';
        }
    }
    else if (gcd[0] == 'possible') {
        first_line.innerHTML = "The greatest common divisior $gcd("+display_coeffs+") = "+gcd[3]+"$.";
        var second_line = document.createElement('div');
        first_line.appendChild(second_line);
        second_line.style="margin-top:10px;";
        if (Number.isInteger(gcd[1])) {
            update_button('red',i);
            second_line.innerHTML = '$b_0 – a_0 = '+display_form(gcd[2],false)+'$ and the test is $\\frac{b_0–a_0}{gcd('+display_coeffs+')} = \\frac{'+display_form(gcd[2],false)+'}{'+gcd[3]+'} = '+gcd[1]+'$ is an integer ($<=>$ fraction divisible), therefore the test does not yield independence.';
            gcd_test_2.innerHTML = '<span style="color:red;"><b>Test does not yield independence</b></span>';
        }
        else {
            update_button('green',i);
            second_line.innerHTML = '$b_0 – a_0 = '+display_form(gcd[2],false)+'$ and the test is $\\frac{b_0–a_0}{gcd('+display_coeffs+')} = \\frac{'+display_form(gcd[2],false)+'}{'+gcd[3]+'} = '+gcd[1]+'$ is not an integer ($<=>$ fraction not divisible), therefore the test yields independence.';
            gcd_test_2.innerHTML = '<span style="color:green;"><b>Test yields independence</b></span>';
        }
    }
    overall_dep();
    arrive_at("gcd",document.getElementById("partbutton_"+i));
    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}

function mivBanerjee(event, i) {
    var forms = partitions[i].forms;
    var banerjee_test = document.getElementById('banerjee_test_'+i);
    var banerjee_test_1 = document.getElementById('banerjee_test_1_'+i);
    var banerjee_test_2 = document.getElementById('banerjee_test_2_'+i);
    banerjee_test_1.innerHTML =  "<div class=\"continue_icon\">j</div> <span id=\"banerjee_test"+i+"_span\" class=\"cont_1_clicked\">Banerjee Test:</span>";
    var bnj = banerjee(forms[0],forms[1]);
    var supported0 = false;
    var supported1 = false;
    var takes0 = false;
    var takes1 = false;
    var result = document.createElement('div');
    banerjee_test.appendChild(result);
    if (bnj[0].length == 1) {
        if (bnj[0][0].type == 'val') {
            if (bnj[0][0].value <= 0) {
                takes0 = true;
            }
            supported0 = true;
        }
    } 
    if (bnj[1].length == 1) {
        if (bnj[1][0].type == 'val') {
            if (bnj[1][0].value >= 0) {
                takes1 = true;
            }
            supported1 = true;
        }
    }
    result.style="margin-top:10px; line-height:30px;";
    if (!supported0 && !supported1) {
        banerjee_test_2.innerHTML = '<span style="color:orange;"><b>Cannot determine</b></span>';
        update_button('orange',i);
        result.innerHTML = "$min_R h = "+display_form(bnj[2],false)+"-("+display_form(bnj[3],false)+") = "+display_form(bnj[0],false)+" \\le 0$ <span style=\"margin: 0 15px; color:orange\"><b>Unknown</b></span> <br>$max_R h = "+display_form(bnj[4],false)+" - ("+display_form(bnj[5],false)+") = "+display_form(bnj[1],false)+" \\ge 0$ <span style=\"margin-left:15px; color:orange\"><b>Unknown</b></span> <br>Cannot determine if there is solution in range R.";
    }
    else if (!takes0 && !supported1) {
        banerjee_test_2.innerHTML = '<span style="color:green;"><b>Test yields independence</b></span>';
            update_button('green',i);
        result.innerHTML = "$min_R h = "+display_form(bnj[2],false)+"-("+display_form(bnj[3],false)+") = "+display_form(bnj[0],false)+" \\le 0$ <span style=\"margin: 0 15px; color:red\"><b>False</b></span> <br>$max_R h = "+display_form(bnj[4],false)+" - ("+display_form(bnj[5],false)+") = "+display_form(bnj[1],false)+" \\ge 0$ <span style=\"margin-left:15px; color:orange\"><b>Unknown</b></span> <br>No solution in range R, yields independence.";
    }
    else if (!supported0 && !takes1) {
        banerjee_test_2.innerHTML = '<span style="color:green;"><b>Test yields independence</b></span>';
            update_button('green',i);
        result.innerHTML = "$min_R h = "+display_form(bnj[2],false)+"-("+display_form(bnj[3],false)+") = "+display_form(bnj[0],false)+" \\le 0$ <span style=\"margin: 0 15px; color:orange\"><b>Unknown</b></span> <br>$max_R h = "+display_form(bnj[4],false)+" - ("+display_form(bnj[5],false)+") = "+display_form(bnj[1],false)+" \\ge 0$ <span style=\"margin-left:15px; color:red\"><b>False</b></span> <br>No solution in range R, yields independence.";
    }
    else if (takes0 && takes1) {
        banerjee_test_2.innerHTML = '<span style="color:orange;"><b>Test does not yield independence (soft)</b></span>';
        update_button('orange',i);
       result.innerHTML = "$min_R h = "+display_form(bnj[2],false)+"-("+display_form(bnj[3],false)+") = "+display_form(bnj[0],false)+" \\le 0$ <span style=\"margin: 0 15px; color:green\"><b>True</b></span> <br>$max_R h = "+display_form(bnj[4],false)+" - ("+display_form(bnj[5],false)+") = "+display_form(bnj[1],false)+" \\ge 0$ <span style=\"margin-left:15px; color:green\"><b>True</b></span> <br>There is a real solution in the range R. Integer solution may still not be possible.";
    }
    else if (takes0 && !takes1) {
        banerjee_test_2.innerHTML = '<span style="color:green;"><b>Test yields independence</b></span>';
        update_button('green',i);
        result.innerHTML = "$min_R h = "+display_form(bnj[2],false)+"-("+display_form(bnj[3],false)+") = "+display_form(bnj[0],false)+" \\le 0$ <span style=\"margin: 0 15px; color:green\"><b>True</b></span> <br>$max_R h = "+display_form(bnj[4],false)+" - ("+display_form(bnj[5],false)+") = "+display_form(bnj[1],false)+" \\ge 0$ <span style=\"margin-left:15px; color:red\"><b>False</b></span> <br>No solution in range R, yields independence.";
    }
    else if (!takes0 && takes1) {
        banerjee_test_2.innerHTML = '<span style="color:green;"><b>Test yields independence</b></span>';
        update_button('green',i);
        result.innerHTML = "$min_R h = "+display_form(bnj[2],false)+"-("+display_form(bnj[3],false)+") = "+display_form(bnj[0],false)+" \\le 0$ <span style=\"margin: 0 15px; color:red\"><b>False</b></span> <br>$max_R h = "+display_form(bnj[4],false)+" - ("+display_form(bnj[5],false)+") = "+display_form(bnj[1],false)+" \\ge 0$ <span style=\"margin-left:15px; color:green\"><b>True</b></span> <br>No solution in range R, yields independence.";
    }
    overall_dep();
    arrive_at("banerjee",document.getElementById("partbutton_"+i));
    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}

function update_button(color,i) {
    if (color == 'red') {
        if (miv_button[i] == 'grey') { document.getElementById("partbutton_"+i).classList.add('parttab_button_red'); miv_button[i] = 'red'; }
    }
    else if (color == 'orange') {
        if (miv_button[i] == 'red') { document.getElementById("partbutton_"+i).classList.remove('parttab_button_red'); }
        if (miv_button[i] == 'green') {}
        else { document.getElementById("partbutton_"+i).classList.add('parttab_button_orange'); miv_button[i] = 'orange'; }
    }
    else if (color == 'green') {
        if (miv_button[i] == 'red') { document.getElementById("partbutton_"+i).classList.remove('parttab_button_red'); }
        if (miv_button[i] == 'orange') { document.getElementById("partbutton_"+i).classList.remove('parttab_button_orange'); }
        document.getElementById("partbutton_"+i).classList.add('parttab_button_green');
        miv_button = 'green';
    }
}

function sivTypeThis(event, i) {
    var forms = partitions[i].forms;
    var type = siv_form(forms);
    //console.log(type);
    var determine_div = document.getElementById("determine_div"+i);
    var determine_div_2 = document.getElementById("determine_div"+i+"_2");
    determine_div_2.innerHTML=type[0];
    determine_div_2.style="font-size:18px; text-transform:uppercase; font-weight:700; color:red; text-shadow: #fff 0 1px 0;"
    var determine_div_1 = document.getElementById("determine_div"+i+"_1");
    determine_div_1.innerHTML =  "<div class=\"continue_icon\">j</div> <span id=\"determine_div"+i+"_span\" class=\"cont_1_clicked\">SIV Type:</span>";
    var tab = document.getElementById("parttab"+i);
    var remove2 = document.getElementById("remove2_"+i);
    remove2.style="display:none;";
    var update2 = document.getElementById("update2_"+i);
    update2.innerHTML = '<div>Determine the type of the SIV based on its form: <div class="vis_strong" style="display:inline-block; text-decoration:underline; color:blue; margin: 0 3px;"><b>STRONG</b></div>, <div class="vis_weak" style="display:inline-block; text-decoration:underline; color:blue; margin: 0 3px;"><b>WEAK</b></div>, <div class="vis_weakzero" style="display:inline-block; text-decoration:underline; color:blue; margin: 0 3px;"><b>WEAK-ZERO</b></div>, <div class="vis_weakcross" style="display:inline-block; text-decoration:underline; color:blue; margin: 0 3px;"><b>WEAK-CROSSING</b></div>.';
    if (type[0] == 'strong') {
        put_info('strong');
        var show_form = document.createElement('div');
        show_form.innerHTML = "The generic form of a STRONG SIV is: <p><$a*i+c_1,a*i+c_2$>, where $i$ - loop index, $a$ - index coefficient, $c_1$ and $c_2$ - constants.</p>";
        show_form.style = "margin-top:10px;"
        var our_values = document.createElement('div');
        our_values.innerHTML = "In this partition: index $i = "+type[1]+"$, coefficient $a = "+display_form(type[2],false)+"$ and constants $c_1 = "+display_form(type[3],false)+"$ , $c_2 = "+display_form(type[4],false)+"$.";
        our_values.style="margin-top:10px";
        tab.appendChild(show_form);
        tab.appendChild(our_values);
        var show_dist = document.createElement('div');
        show_dist.innerHTML = "We are interested in calculating the dependence distance: $d = \\frac{c_1 - c_2}{a}$. A dependence exists between two references only if access to common elements occurs within the bounds set by the loop (given SIV, there must be only one loop involved in the two references). This access will occur only when $d$ is an integer and $|d| \\lt U - L$, where $U$ and $L$ are the loop upper and lower bounds.";
        show_dist.style="margin-top:10px;"
        var pen_step = document.createElement('div');
        pen_step.style="margin-top:10px;"
        pen_step.innerHTML = "Calculate $d$ ; if it is an integer and its absolute value falls within the range of the loop, there exists a dependence whose direction can be determined by the sign of $d$. Otherwise, no dependence exists.";
        var last_step = document.createElement('div');
        var last_step_1 = document.createElement('span');
        var last_step_2 = document.createElement('span');
        last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+i+"_span\" class=\"cont_1\" onclick=\"strongSivThis(event,"+i+")\">Dependence:</span>";
        last_step_2.innerHTML = "...";
        last_step_1.id = "calculate_div_"+i;
        last_step_2.id = "calculate_div_"+i+"_2";
        last_step.appendChild(last_step_1);
        last_step.appendChild(last_step_2);
        last_step.style="margin-top:10px;"
        tab.appendChild(show_dist);
        tab.appendChild(pen_step);
        tab.appendChild(last_step);
    }
    else if (type[0] == 'weak') {
        put_info('weak');
        var show_form = document.createElement('div');
        show_form.innerHTML = "The generic form of a WEAK SIV is: <p><$a_1*i+c_1,a_2*i+c_2$>, where $i$ - loop index, $a_1$ and $a_2$ - index coefficients, $c_1$ and $c_2$ - constants.</p>";
        show_form.style = "margin-top:10px;"
        var our_values = document.createElement('div');
        our_values.innerHTML = "In this partition: index $i = "+type[1]+"$, coefficient $a_1 = "+display_form(type[2],false)+"$, coefficient $a_2 = "+display_form(type[3],false)+"$ and constants $c_1 = "+display_form(type[4],false)+"$ , $c_2 = "+display_form(type[5],false)+"$.";
        our_values.style="margin-top:10px";
        var about_gcd = document.createElement('div');
        about_gcd.style="margin-top:10px;";
        about_gcd.innerHTML = "A subscript of this form can be tested exactly by constructing all solutions of the linear diophantine equation: $a_1*x – b_1*y = b_0 – a_0$ , This equation system has a solution if and only if the greatest common denominator of $a_1$ and $b_1$ divides $b_0 – a_0$.";
        tab.appendChild(show_form);
        tab.appendChild(our_values);
        tab.appendChild(about_gcd);
        var last_step = document.createElement('div');
        var last_step_1 = document.createElement('span');
        var last_step_2 = document.createElement('span');
        last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+i+"_span\" class=\"cont_1\" onclick=\"weakSivThis(event,"+i+")\">Dependence:</span>";
        last_step_2.innerHTML = "...";
        last_step_1.id = "calculate_div_"+i;
        last_step_2.id = "calculate_div_"+i+"_2";
        last_step.appendChild(last_step_1);
        last_step.appendChild(last_step_2);
        last_step.style="margin-top:10px;"
        tab.appendChild(last_step);
    }
    else if (type[0] == 'weak-zero') {
        put_info('weak_zero');
        var show_form = document.createElement('div');
        show_form.innerHTML = "The generic form of a WEAK-ZERO SIV is either: <p><$c_1,a_2*i+c_2$> <span style=\"margin: 0 5px;\">or</span> <$a_1*i+c_1,c_2$> where $i$ - loop index, $a_1$/$a_2$ - index coefficient, $c_1$ and $c_2$ - constants.</p>";
        show_form.style = "margin-top:10px;"
        var our_values = document.createElement('div');
        if (type[2] == 0) {
            our_values.innerHTML = "In this partition the first coefficient is zero ($a_1 = 0$). The index $i = "+type[1]+"$, non-zero coefficient $a_2 = "+display_form(type[3],false)+"$ and constants $c_1 = "+display_form(type[4],false)+"$ , $c_2 = "+display_form(type[5],false)+"$.";
        }
        else {
            our_values.innerHTML = "In this partition the second coefficient is zero ($a_2 = 0$). The index $i = "+type[1]+"$, non-zero coefficient $a_1 = "+display_form(type[2],false)+"$ and constants $c_1 = "+display_form(type[4],false)+"$ , $c_2 = "+display_form(type[5],false)+"$.";
        }
        our_values.style="margin-top:10px;";
        var about_test = document.createElement('div');
        about_test.style="margin-top:10px;";
        if (type[2] == 0) {
            about_test.innerHTML = "Because $a_1$ is equal to zero, the dependence equation reduces to $i = \\frac{c_1-c_2}{a_2}$ .The reference in which the coefficient is zero references only one array element during the loop. Given that the other coefficient is nonzero, the two lines can intersect at only one point—that defined in the equation previous. Thus, the test consists merely of checking that the computed value is an integer and is within the loop bounds.";
        }
        else {
            about_test.innerHTML = "Because $a_2$ is equal to zero, the dependence equation reduces to $i = \\frac{c_2-c_1}{a_1}$ .The reference in which the coefficient is zero references only one array element during the loop. Given that the other coefficient is nonzero, the two lines can intersect at only one point—that defined in the equation previous. Thus, the test consists merely of checking that the computed value is an integer and is within the loop bounds.";
        }
        tab.appendChild(show_form);
        tab.appendChild(our_values);
        tab.appendChild(about_test);
        var last_step = document.createElement('div');
        var last_step_1 = document.createElement('span');
        var last_step_2 = document.createElement('span');
        last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+i+"_span\" class=\"cont_1\" onclick=\"weakZeroThis(event,"+i+")\">Dependence:</span>";
        last_step_2.innerHTML = "...";
        last_step_1.id = "calculate_div_"+i;
        last_step_2.id = "calculate_div_"+i+"_2";
        last_step.appendChild(last_step_1);
        last_step.appendChild(last_step_2);
        last_step.style="margin-top:10px;"
        tab.appendChild(last_step);
    }
    else if (type[0] == 'weak-crossing') {
        put_info('weak_crossing');
        var show_form = document.createElement('div');
        show_form.innerHTML = "The generic form of a WEAK-CROSSING SIV is: <p><$a*i+c_1,-a*i+c_2$> where $i$ - loop index, $a$ - index coefficient, $c_1$ and $c_2$ - constants.</p>";
        show_form.style = "margin-top:10px;"
        var our_values = document.createElement('div');
        our_values.innerHTML = "In this partition: index $i = "+type[1]+"$ , coefficient $a_1 = "+display_form(type[2],false)+"$ , coefficient $a_2 = "+display_form(type[3],false)+"$ and constants $c_1 = "+display_form(type[4],false)+"$ , $c_2 = "+display_form(type[5],false)+"$.";
        tab.appendChild(show_form);
        tab.appendChild(our_values);
        var about_test = document.createElement('div');
        about_test.style="margin-top:10px;"
        about_test.innerHTML = 'Given that the absolute values of the slopes of the lines are the same, they “move” away from a given point at exactly the same rate, although one moves up and the other moves down. As a result, the lines are symmetric about a vertical line through their point of intersection. <img style="width:30%; padding:5px; float:right;" src="img/cross.png"> Because of this symmetry, the ends of all dependences are on opposite sides of a crossing point—the point where the lines intersect. To locate the crossing point, the substitution of $a_2 = - a_1$ is made, deriving: $i = \\frac{c_2-c_1}{2a_1}$ . Since all dependences span the crossing point, determining whether dependences exist is a simple check that the resulting i is within the loop bounds and is either integer or has a non-integer part equal to $\\frac{1}{2}$. The second part of the condition arises because each line moves symmetrically from the crossing point; if that point is not halfway between two integers, then the lines cannot intersect integers on the y-axis at integral points on the x-axis.';
       // var crossing_img = document.createElement('div');
        //crossing_img.innerHTML = '<img style="width:20%; "src="http://avasiloaie.com/wp-content/uploads/2019/03/Screenshot-2019-03-03-at-6.12.32-pm.png">';
        tab.appendChild(about_test);
        var last_step = document.createElement('div');
        var last_step_1 = document.createElement('span');
        var last_step_2 = document.createElement('span');
        last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+i+"_span\" class=\"cont_1\" onclick=\"weakCrossingThis(event,"+i+")\">Dependence:</span>";
        last_step_2.innerHTML = "...";
        last_step_1.id = "calculate_div_"+i;
        last_step_2.id = "calculate_div_"+i+"_2";
        last_step.appendChild(last_step_1);
        last_step.appendChild(last_step_2);
        last_step.style="margin-top:10px;"
        tab.appendChild(last_step);
        //tab.appendChild(crossing_img);
    }
       
    $('.vis_strong').each(function() {
         $(this).qtip({
             content: {
                 text: 'The coefficients of the two occurrences of the index i are constant and equal' },
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
     $('.vis_weak').each(function() {
         $(this).qtip({
             content: {
                 text: 'Differing coefficients on the loop induction variable'},
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
     $('.vis_weakzero').each(function() {
         $(this).qtip({
             content: {
                 text: 'If one of the two coefficients is 0 : i.e., a<sub>1</sub> = 0 or a<sub>2</sub> = 0'},
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
     $('.vis_weakcross').each(function() {
         $(this).qtip({
             content: {
                text: 'Coefficients are a<sub>1</sub> = -a<sub>2</sub>'},
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    /*var form_div = document.createElement("div");
    form_div.innerHTML = "<span>Form:</span><span>"+display_form(forms[0])+" , "+display_form(forms[1])+"</span>";
    determine_div.appendChild(form_div);*/
    /////////////////////////////// FORM FIRST THEN TYPE
}

function weakCrossingThis(event, I) {
    var i, j;
    var forms = partitions[I].forms;
    var partbutton = document.getElementById("partbutton_"+I);
    //document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
    //document.getElementById("partbutton_"+I).classList.remove('parttab_button');
    var type = siv_form(forms);
    var not_supported = false;
    var tab = document.getElementById("parttab"+I);
    var eq1 = document.createElement("div");
    var invar = new Map();
    eq1.style="margin-top:10px;";
    var reverse = get_form_mult(type[4],new Array(new Value(-1)));
    forms = partitions[I].forms;
    disp1 = display_form(type[5],false);
    disp2 = display_form(type[4],false);
    disp_type_1 = display_form(type[5],false);
    disp_type_2 = display_form(reverse,false);
    disp_type_3 = display_form(get_form_mult(type[2],new Array(new Value(2))));
    forms = partitions[I].forms;
    disp_type_4 = display_form(get_form_add(type[4],get_form_mult(type[5],new Array(new Value(-1)))),false);
    strong_calc = weak_crossing(type[1],type[2],type[6],type[7]);
    
    /*diff = get_form_add(strong_calc[0],get_form_mult(strong_calc[1],new Array(new Value(-1))));
    possible = 'undecided';
    var response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';
    if (strong_calc[1].length == 1) {
        if (strong_calc[1][0].type == 'val') {
            if (Number.isInteger(strong_calc[1][0].value) || (Math.floor(strong_calc[1][0].value)-strong_calc[1][0].value == 0.5) || (Math.floor(strong_calc[1][0].value)-strong_calc[1][0].value == -0.5)) {
                possible = 'true';
            }
            else {
                possible = 'false';
            }
        }
    }

    if (possible == 'false') {
        eq1.innerHTML = "$L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var eq2 = document.createElement('div');
        eq2.style="margin-top:10px;"
        tab.appendChild(eq2);
        eq2.innerHTML = "The crossing point $i = "+ display_form(strong_calc[1],false) +"$ is neither and integer or halfway between two integers, thus a dependency cannot exist."; 
        document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
        response = 'Test yields <span style="font-weight:700; color:green;">independence</span>';
    }
    else if (possible == 'undecided') {
        eq1.innerHTML = "$L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var eq2 = document.createElement('div');
        eq2.style="margin-top:10px;"
        tab.appendChild(eq2);
        eq2.innerHTML = "The crossing point $= "+ display_form(strong_calc[1],false) +"$ has unknown variables. Cannot decide whether a dependence does not exist."; 
        document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
    }*/
    

    bounds = true;
    forms = partitions[I].forms;

    //strong_calc = weak_crossing(type[1],type[2],type[4],type[5]);
    if (strong_calc[0].length == 1 && strong_calc[3].length == 1 ) {
        if (strong_calc[0][0].type == 'var' && strong_calc[3][0].type == 'var') {
            if (strong_calc[0][0].elems.length == 1 && strong_calc[3][0].elems.length == 1) {
                if (strong_calc[0][0].elems[0].type == 'val' && strong_calc[3][0].elems[0].type == 'val') {
                    if (strong_calc[0][0].elems[0].value > strong_calc[3][0].elems[0].value) {
                        bounds = false;
                    }
                }
            }
        }
        else if (strong_calc[0][0].type == 'val' && strong_calc[3][0].type == 'val') {
            if (strong_calc[0][0].value > strong_calc[3][0].value) {
                bounds = false;
            }
        }
    }
    if (strong_calc[0].length == 1 && strong_calc[2].length == 1 ) {
        if (strong_calc[0][0].type == 'var' && strong_calc[2][0].type == 'var') {
            if (strong_calc[0][0].elems.length == 1 && strong_calc[2][0].elems.length == 1) {
                if (strong_calc[0][0].elems[0].type == 'val' && strong_calc[2][0].elems[0].type == 'val') {
                    if (strong_calc[0][0].elems[0].value < strong_calc[2][0].elems[0].value) {
                        bounds = false;
                    }
                }
            }
        }
        else if (strong_calc[0][0].type == 'val' && strong_calc[2][0].type == 'val') {
            if (strong_calc[0][0].value < strong_calc[2][0].value) {
                bounds = false;
            }
        }
    }

    tab.appendChild(eq1);
    eq1.innerHTML = "$i = \\frac{"+disp1+" - ("+disp2+")}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";

    for (i = 0; i < strong_calc[0].length; i ++) {
        if ( strong_calc[0][i].divided != null ) {
            not_supported = true;
            invar.set(strong_calc[0][i].divided.variable,true);
        }
        if ( strong_calc[0][i].type == 'var' ) { invar.set(strong_calc[0][i].variable); not_supported = true; }
        else if (strong_calc[0][i].type == 'var') {
            for (j = 0; j < strong_calc[0][i].elems.length; j ++) {
                if ( strong_calc[0][i].elems[j].divided != null ) {
                    not_supported = true;
                    invar.set(strong_calc[0][i].elems[j].divided.variable,true);
                }
                if ( strong_calc[0][i].elems[j].type == 'var' ) { invar.set(strong_calc[0][i].variable); not_supported = true; }
            }
        }
    }
    var invar_re = "";
    for (i = 0; i < invar.entriesArray().length; i++) {
        invar_re += invar.entriesArray()[i][0] + " , ";
    }
    if (invar.entriesArray().length > 0) invar_re = invar_re.substring(0,invar_re.length-3);
    
    if (not_supported) {
        document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
        // show stuff without doing weird
        eq1.innerHTML = "$i = \\frac{"+disp_type_4+"}{"+disp_type_3+"}$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var eq2 = document.createElement('div');
        eq2.style="margin-top:10px;"
        eq2.innerHTML = "Whether a could dependency exist depends on the loop invariant variables: $"+ invar_re +"$ in $i$."
        tab.appendChild(eq2);
        document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
    }

    else if (bounds) {
        var eq2 = document.createElement('div');
        eq2.style="margin-top:10px;"
        tab.appendChild(eq2);
        if (Number.isInteger(strong_calc[0][0].value)) {
            eq2.innerHTML = "The crossing point $i = "+ display_form(strong_calc[0],false) +"$ is an integer and the condition $L \\le i \\le U$ <span style=\"margin:0 10px;\">is</span> $"+display_form(strong_calc[2],false)+" \\le "+display_form(strong_calc[0],false) +" \\le "+display_form(strong_calc[3],false) +"$ <span style=\"margin:0 10px; color:green;\"><b>True</b></span>, $i$ is in bounds, thus the test does not yield independence.";
            document.getElementById("partbutton_"+I).classList.add('parttab_button_red');
            response = 'Test <span style="font-weight:700; color:red;">does not</span> yield independence';
        }
        else if (Math.floor(strong_calc[0][0].value)-strong_calc[0][0].value == 0.5) {
            eq2.innerHTML = "The crossing point $i = "+ display_form(strong_calc[0],false) +"$ is half-way between two integers and the condition $L \\le i \\le U$ <span style=\"margin:0 10px;\">is</span> $"+display_form(strong_calc[2],false)+" \\le "+display_form(strong_calc[0],false) +" \\le "+display_form(strong_calc[3],false) +"$ <span style=\"margin:0 10px; color:green;\"><b>True</b></span>, $i$ is in bounds, thus the test does not yield independence.";
            document.getElementById("partbutton_"+I).classList.add('parttab_button_red');
            response = 'Test <span style="font-weight:700; color:red;">does not</span> yield independence';
        }
        else {
            eq2.innerHTML = "Condition $L \\le i \\le U$ <span style=\"margin:0 10px;\">is</span> $"+display_form(strong_calc[2],false)+" \\le "+display_form(strong_calc[0],false) +" \\le "+display_form(strong_calc[3],false) +"$ <span style=\"margin:0 10px; color:green;\"><b>True</b></span>, $i$ is in bounds, but the crossing point $i = "+ display_form(strong_calc[0],false) +"$ is neither an integer or half-way between two integers, thus the test yields independence.";
            document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
            response = 'Test <span style="font-weight:700; color:green;">yields</span> independence';
        }
    }
    else {
        var eq2 = document.createElement('div');
        eq2.style="margin-top:10px;"
        tab.appendChild(eq2);
        eq2.innerHTML = "Condition $L \\le i \\le U$ <span style=\"margin:0 10px;\">is</span> $"+display_form(strong_calc[2],false)+" \\le "+display_form(strong_calc[0],false) +" \\le "+display_form(strong_calc[3],false) +"$ <span style=\"margin:0 10px; color:red;\"><b>False</b></span>, $i$ is not in bounds, thus the test yields independence.";
        document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
        response = 'Test yields <span style="font-weight:700; color:green;">independence</span>';
    }


    /*else {
        eq1.innerHTML = "$i = \\frac{"+disp_type_1+(disp_type_2[0] != '-' ? '+'+disp_type_2 : disp_type_2)+"}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var dist_abs = '%';
        var comparable = false;
        var result = true;
        document.getElementById("partbutton_"+I).classList.add('parttab_button_red');
        var eq2 = document.createElement("div");
        eq2.style="margin-top:10px;";
        if (strong_calc[0][0].type == 'val' && strong_calc[1][0].type == 'val' && strong_calc[1].length == 1 && strong_calc[0].length == 1) {
            if (strong_calc[0][0].value < 0 ) {
                if (-strong_calc[0][0].value >= strong_calc[1][0].value) {
                    result = false;
                }
            }
            else {
                if (strong_calc[0][0].value >= strong_calc[1][0].value) {
                    result = false;
                }
            }
            comparable = true;
        }
        if (strong_calc[0][0].type == 'val') {
            if (strong_calc[0][0].value < 0) {
                dist_abs = true;
            }
            else {
                dist_abs = false;
            }
        }
        result_span = result ? "<span style=\" color:green; font-weight:700\">True</span>" : "<span style=\"color:red; font-weight:700\">False</span>";
        if (dist_abs != '%' && comparable == true ) {
            eq2.innerHTML += "$|i| \\lt U - L$ <span style=\"margin-left:10px\"></span> is <span style=\"margin-left:10px\"></span> $|"+strong_calc[0][0].value+"| \\lt "+ display_form(strong_calc[3],false) + " " + display_form(get_form_mult(strong_calc[2],new Array(new Value(-1))),false)+"$ <span style=\"margin-left:10px\"></span> $\\equiv$ <span style=\"margin-left:10px\"></span> $"+(dist_abs ? (strong_calc[0][0].value *(-1)) : strong_calc[0][0].value)+" \\lt "+display_form(strong_calc[1],false)+"$ <span style=\"margin-left:10px\"> "+ result_span ;
        }
        tab.appendChild(eq2);
        response = result ? 'Test <span style="font-weight:700; color:red;">does not</span> yield independence' : 'Test yields <span style="font-weight:700; color:green;">independence</span>';
        if (result == false) {
            document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
            document.getElementById("partbutton_"+I).classList.remove('parttab_button_red');
        }
    }*/
    var last_step_1 = document.getElementById("calculate_div_"+I);
    var last_step_2 = document.getElementById("calculate_div_"+I+"_2");
    last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+I+"_span\" class=\"cont_1_clicked\">Dependence:</span>";
    last_step_2.innerHTML = response;

    overall_dep();
    /////////////// if response cutarica
    /////////////// update thing after tabs
    //////////////// <3
    arrive_at("weak_crossing",document.getElementById("partbutton_"+I));

    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}

function weak_siv(it,a,c1,c2) {
    var range = iterators_se.get(it);
    var lower = range[0];
    var upper = range[1];
    var i = get_form_div(get_form_add(c2,get_form_mult(c1,new Array(new Value(-1)))),a);
    return [i,get_form(lower),get_form(upper)];
}

function weakZeroThis(event, I) {
    var i, j;
    var forms = partitions[I].forms;
    var partbutton = document.getElementById("partbutton_"+I);
    //document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
    //document.getElementById("partbutton_"+I).classList.remove('parttab_button');
    var type = siv_form(forms);
    var not_supported = false;
    var tab = document.getElementById("parttab"+I);
    var eq1 = document.createElement("div");
    var invar = new Map();
    eq1.style="margin-top:10px;";
    var strong_calc = null;
    if (type[2] == 0) {
        disp1 = display_form(type[5],false);
        disp2 = display_form(type[4],false)
        reverse = get_form_mult(type[4],new Array(new Value(-1)));
        disp_type_1 = display_form(type[5],false);
        disp_type_2 = display_form(reverse,false);
        disp_type_3 = display_form(type[3],false);
        disp_type_4 = display_form(get_form_add(type[4],get_form_mult(type[5],new Array(new Value(-1)))),false);
        strong_calc = weak_siv(type[1],type[3],type[5],type[4]);
    }
    else {
        disp1 = display_form(type[4],false);
        disp2 = display_form(type[5],false)
        reverse = get_form_mult(type[5],new Array(new Value(-1)));
        disp_type_1 = display_form(type[4],false);
        disp_type_2 = display_form(reverse,false);
        disp_type_3 = display_form(type[2],false);
        disp_type_4 = display_form(get_form_add(type[5],get_form_mult(type[4],new Array(new Value(-1)))),false);
        strong_calc = weak_siv(type[1],type[2],type[4],type[5]);
    }
    tab.appendChild(eq1);
    if (disp_type_2[0] == '0') {
        bgn = '-'+disp_type_2;
    }
    else if (disp_type_2[0] != '-') {
        bgn = '+'+disp_type_2;
    }
    else {
        bgn = disp_type_2;
    }
    eq1.innerHTML = "$i = \\frac{"+disp2+" - ("+disp1+")}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[1],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
    var has_float = false;
    var the_float = null;
    var the_float_2 = null;
    var response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';
    for (i = 0; i < strong_calc[0].length; i++) {
        if (strong_calc[0][i].type == 'val') {
            if (!Number.isInteger(strong_calc[0][i].value)) {
                the_float = i;
                the_float_2 = strong_calc[0][i].value+"";
                has_float = true;
            }
        }
    }
    for (i = 0; i < strong_calc[0].length; i ++) {
        if ( strong_calc[0][i].divided != null ) {
            not_supported = true;
            invar.set(strong_calc[0][i].divided.variable,true);
        }
        if ( strong_calc[0][i].type == 'var' ) { invar.set(strong_calc[0][i].variable); not_supported = true; }
        else if (strong_calc[0][i].type == 'var') {
            for (j = 0; j < strong_calc[0][i].elems.length; j ++) {
                if ( strong_calc[0][i].elems[j].divided != null ) {
                    not_supported = true;
                    invar.set(strong_calc[0][i].elems[j].divided.variable,true);
                }
                if ( strong_calc[0][i].elems[j].type == 'var' ) { invar.set(strong_calc[0][i].variable); not_supported = true; }
            }
        }
    }
    var invar_re = "";
    for (i = 0; i < invar.entriesArray().length; i++) {
        invar_re += invar.entriesArray()[i][0] + " , ";
    }
    if (invar.entriesArray().length > 0) invar_re = invar_re.substring(0,invar_re.length-3);

    if (not_supported) {
        document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
        // show stuff without doing weird
        eq1.innerHTML = "$i = \\frac{"+disp2+" - ("+disp1+")}{"+disp_type_3+"}$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[1],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var eq2 = document.createElement('div');
        eq2.style="margin-top:10px;"
        eq2.innerHTML = "Whether a could dependency exist depends on the loop invariant variables: $"+ invar_re +"$ in $i \\ge "+ display_form(strong_calc[1],false) +"$  ,  $i \\le "+ display_form(strong_calc[2],false)+"$";
        tab.appendChild(eq2);
    }
    else if (has_float) {
        if (disp_type_2[0] == '0') {
            bgn = '-'+disp_type_2;
        }
        else if (disp_type_2[0] != '-') {
            bgn = '+'+disp_type_2;
        }
        else {
            bgn = disp_type_2;
        }
        eq1.innerHTML =  "$i = \\frac{"+disp2+" - ("+disp1+")}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:5px\"></span>";
        if (strong_calc[0].length == 1) {
           eq1.innerHTML += "is not an integer, therefore references to the same element cannot occur on a loop iteration for both subscripts -> no dependency.";
           response = 'Test yields <span style="font-weight:700; color:green;">independence</span>';
           document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
        }
        else {
            document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
            var old_form = display_form(strong_calc[0],false);
            eq1.innerHTML += "has non-integer element $";
            for (j = 0; j < strong_calc[0].length; j ++) {
                if (j > the_float) {
                    strong_calc[0][j-1] = strong_calc[0][j];
                }
            }
            strong_calc[0].pop();
            eq1.innerHTML += the_float_2+"$. There is no dependence unless $"+display_form(strong_calc[0],false)+"$ makes it so that the distance in total is an integer. Even in this case there can still be no dependence if it is not in bounds $"+old_form+" \\ge "+display_form(strong_calc[1],false)+ "$ and $\\le "+display_form(strong_calc[2],false)+"$";
        }
    }
    else {
        if (disp_type_2[0] == '0') {
            bgn = '-'+disp_type_2;
        }
        else if (disp_type_2[0] != '-') {
            bgn = '+'+disp_type_2;
        }
        else {
            bgn = disp_type_2;
        }
        eq1.innerHTML = "$i = \\frac{"+disp2+" - ("+disp1+")}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[1],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var comparable = false;
        var result = true;
        document.getElementById("partbutton_"+I).classList.add('parttab_button_red');
        var eq2 = document.createElement("div");
        eq2.style="margin-top:10px;";
        if (strong_calc[0][0].type == 'val' && strong_calc[1].length == 1 && strong_calc[2].length == 1) {
                if (strong_calc[0][0].value < strong_calc[1][0].value || strong_calc[0][0].value > strong_calc[2][0].value) {
                    result = false;
                }
            comparable = true;
        }
        result_span = result ? "<span style=\" color:green; font-weight:700\">True</span>" : "<span style=\"color:red; font-weight:700\">False</span>";
        if (comparable == true ) {
            eq2.innerHTML += "$"+strong_calc[0][0].value+"$ is $\\ge "+display_form(strong_calc[1],false)+"$ and $\\le "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:10px\"> "+ result_span ;
        }
        tab.appendChild(eq2);
        response = result ? 'Test <span style="font-weight:700; color:red;">does not</span> yield independence' : 'Test yields <span style="font-weight:700; color:green;">independence</span>';
        if (result == false) {
            document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
            document.getElementById("partbutton_"+I).classList.remove('parttab_button_red');
        }
    }
    var last_step_1 = document.getElementById("calculate_div_"+I);
    var last_step_2 = document.getElementById("calculate_div_"+I+"_2");
    last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+I+"_span\" class=\"cont_1_clicked\">Dependence:</span>";
    last_step_2.innerHTML = response;

    overall_dep();
    /////////////// if response cutarica
    /////////////// update thing after tabs
    //////////////// <3
    arrive_at("weak_zero",document.getElementById("partbutton_"+I));

    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}

function weakSivThis(event, i) {
    var response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';
    var forms = partitions[i].forms;
    var partbutton = document.getElementById("partbutton_"+i);
    var tab = document.getElementById("parttab"+i);
    var type = siv_form(forms);
    type[3]=get_form_mult(type[3],new Array(new Value(-1)));
    var gcd_result = gcd_test(type[2],type[3],type[6],type[7]);
    var calculate_result = document.createElement('div');
    calculate_result.style = "margin-top:10px;";
    tab.appendChild(calculate_result);
    type[3]=get_form_mult(type[3],new Array(new Value(-1)));
    if (gcd_result[2] == null) {
        response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';
        calculate_result.innerHTML = 'Cannot compute the greatest common divisor $gcd(a_1,a_2) = gcd('+display_form(type[2],false)+','+display_form(type[3],false)+')$ , because of unknown variables in the coefficient of the indexes.';
    }
    else if ((type[2][0].value < 0 && type[3][0].value > 0) || (type[2][0].value > 0 && type[3][0].value < 0)) {
        response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';
        calculate_result.innerHTML = 'Cannot compute the greatest common divisor $gcd(a_1,a_2) = gcd('+display_form(type[2],false)+','+display_form(type[3],false)+')$ , because of negative coefficients (testable when both negative or positive).';
    }
    else if (gcd_result[2] == 1 || gcd_result[2] == -1) {
        calculate_result.innerHTML = 'The greatest common divisor $gcd(a_1,a_2) = gcd('+display_form(type[2],false)+','+display_form(type[3],false)+') = 1$ , which divides everything. Cannot determine dependency or lack thereof.';
        response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';
    }
    else if (gcd_result[0] == null) {
        calculate_result.innerHTML = 'The greatest common divisor $gcd(a_1,a_2) = gcd('+display_form(type[2],false)+','+display_form(type[3],false)+') = '+gcd_result[2] + '$';
        var calculate_result2 = document.createElement('div');
        calculate_result2.style="margin-top:10px;";
        tab.appendChild(calculate_result2);
        calculate_result2.innerHTML = 'Cannot do the GCD test due to unknown variables in equation: $b_0 – a_0 = '+display_form(gcd_result[1])+'$';
        response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';

    }
    else if (Number.isInteger(gcd_result[0])) {
        response = 'Test <span style="font-weight:700; color:red;">does not</span> yield independence';
        calculate_result.innerHTML = 'The greatest common divisor $gcd(a_1,a_2) = gcd('+display_form(type[2],false)+','+display_form(type[3],false)+') = '+gcd_result[2] + '$';
        var calculate_result2 = document.createElement('div');
        calculate_result2.style="margin-top:10px;";
        tab.appendChild(calculate_result2);
        calculate_result2.innerHTML = '$b_0 – a_0 = '+display_form(gcd_result[1],false)+'$ and the test is $\\frac{b_0–a_0}{gcd(a_1,a_2)} = \\frac{'+display_form(gcd_result[1],false)+'}{'+gcd_result[2]+'} = '+gcd_result[0]+'$ is an integer ($<=>$ fraction divisible), therefore the test does not yield independence.';
    }
    else {
        response = 'The GCD test yields <span style="font-weight:700; color:green;">independence</span>';
        calculate_result.innerHTML = 'The greatest common divisor $gcd(a_1,a_2) = gcd('+display_form(type[2],false)+','+display_form(type[3],false)+') = '+gcd_result[2] + '$';
        var calculate_result2 = document.createElement('div');
        calculate_result2.style="margin-top:10px;";
        tab.appendChild(calculate_result2);
        calculate_result2.innerHTML = '$b_0 – a_0 = '+display_form(gcd_result[1],false)+'$ and the test is $\\frac{b_0–a_0}{gcd(a_1,a_2)} = \\frac{'+display_form(gcd_result[1],false)+'}{'+gcd_result[2]+'} = '+gcd_result[0]+'$ is not an integer ($<=>$ fraction not divisible), therefore the GCD test yields independence.';
    }

    if (response == '<span style="font-weight:700; color:orange;">Cannot</span> determine') {
        document.getElementById("partbutton_"+i).classList.add('parttab_button_orange');
    }
    else if (response == 'Test <span style="font-weight:700; color:red;">does not</span> yield independence' ) {
        document.getElementById("partbutton_"+i).classList.add('parttab_button_red');
    }
    else if (response == 'The GCD test yields <span style="font-weight:700; color:green;">independence</span>') {
        document.getElementById("partbutton_"+i).classList.add('parttab_button_green');
    }

    var last_step_1 = document.getElementById("calculate_div_"+i);
    var last_step_2 = document.getElementById("calculate_div_"+i+"_2");
    last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+i+"_span\" class=\"cont_1_clicked\">Dependence:</span>";
    last_step_2.innerHTML = response;
    arrive_at("weak",document.getElementById("partbutton_"+i));
    overall_dep();
    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}

function strongSivThis(event, I) {
    var i, j;
    var forms = partitions[I].forms;
    var partbutton = document.getElementById("partbutton_"+I);
    //document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
    //document.getElementById("partbutton_"+I).classList.remove('parttab_button');
    var type = siv_form(forms);
    var not_supported = false;
    var tab = document.getElementById("parttab"+I);
    var eq1 = document.createElement("div");
    var invar = new Map();
    eq1.style="margin-top:10px;";
    disp1 = display_form(type[3],false);
    disp2 = display_form(type[4],false);
    var reverse = get_form_mult(type[4],new Array(new Value(-1)));
    disp_type_1 = display_form(type[3],false);
    disp_type_2 = display_form(reverse,false);
    disp_type_3 = display_form(type[2],false);
    //disp_type_4 = display_form(get_form_add(type[3],get_form_mult(type[4],new Array(new Value(-1)))),false);
    var strong_calc = strong_siv(type);
    tab.appendChild(eq1);
    if (disp_type_2[0] == '0') {
        bgn = '-'+disp_type_2;
    }
    else if (disp_type_2[0] != '-') {
        bgn = '+'+disp_type_2;
    }
    else {
        bgn = disp_type_2;
    }
    eq1.innerHTML = "$d = \\frac{"+disp1+" - ("+disp2+")}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
    var has_float = false;
    var the_float = null;
    var the_float_2 = null;
    var response = '<span style="font-weight:700; color:orange;">Cannot</span> determine';
    for (i = 0; i < strong_calc[0].length; i++) {
        if (strong_calc[0][i].type == 'val') {
            if (!Number.isInteger(strong_calc[0][i].value)) {
                the_float = i;
                the_float_2 = strong_calc[0][i].value+"";
                has_float = true;
            }
        }
    }
    for (i = 0; i < strong_calc[0].length; i ++) {
        if ( strong_calc[0][i].divided != null ) {
            not_supported = true;
            invar.set(strong_calc[0][i].divided.variable,true);
        }
        if ( strong_calc[0][i].type == 'var' ) { invar.set(strong_calc[0][i].variable); not_supported = true; }
        else if (strong_calc[0][i].type == 'var') {
            for (j = 0; j < strong_calc[0][i].elems.length; j ++) {
                if ( strong_calc[0][i].elems[j].divided != null ) {
                    not_supported = true;
                    invar.set(strong_calc[0][i].elems[j].divided.variable,true);
                }
                if ( strong_calc[0][i].elems[j].type == 'var' ) { invar.set(strong_calc[0][i].variable); not_supported = true; }
            }
        }
    }
    var invar_re = "";
    for (i = 0; i < invar.entriesArray().length; i++) {
        invar_re += invar.entriesArray()[i][0] + " , ";
    }
    if (invar.entriesArray().length > 0) invar_re = invar_re.substring(0,invar_re.length-3);

    if (not_supported) {
        document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
        // show stuff without doing weird aici dera disp4 - -------------------
        eq1.innerHTML = "$d = \\frac{{"+disp1+" - ("+disp2+")}}{"+disp_type_3+"}$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var eq2 = document.createElement('div');
        eq2.style="margin-top:10px;"
        eq2.innerHTML = "Whether a could dependency exist depends on the loop invariant variables: $"+ invar_re +"$ in $|d| \\le "+ display_form(strong_calc[3],false) + " " + display_form(get_form_mult(strong_calc[2],new Array(new Value(-1))),false)+"$ <span style=\"margin-left:10px\"></span> $\\equiv$ <span style=\"margin-left:10px\"></span> $|d| \\le "+display_form(strong_calc[1],false)+"$";
        tab.appendChild(eq2);
    }
    else if (has_float) {
        if (disp_type_2[0] == '0') {
            bgn = '-'+disp_type_2;
        }
        else if (disp_type_2[0] != '-') {
            bgn = '+'+disp_type_2;
        }
        else {
            bgn = disp_type_2;
        }
        eq1.innerHTML =  "$d = \\frac{"+disp1+" - ("+disp2+")}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:5px\"></span>";
        if (strong_calc[0].length == 1) {
           eq1.innerHTML += "is not an integer, therefore references to the same element cannot occur on a loop iteration for both subscripts -> no dependency.";
           response = 'Test yields <span style="font-weight:700; color:green;">independence</span>';
           document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
        }
        else {
            document.getElementById("partbutton_"+I).classList.add('parttab_button_orange');
            var old_form = display_form(strong_calc[0],false);
            eq1.innerHTML += "has non-integer element $";
            for (j = 0; j < strong_calc[0].length; j ++) {
                if (j > the_float) {
                    strong_calc[0][j-1] = strong_calc[0][j];
                }
            }
            strong_calc[0].pop();
            eq1.innerHTML += the_float_2+"$. There is no dependence unless $"+display_form(strong_calc[0],false)+"$ makes it so that the distance in total is an integer. Even in this case there can still be no dependence if it is not in bounds $"+old_form+" \\le "+display_form(strong_calc[1],false)+ "$.";
        }
    }
    else {
        if (disp_type_2[0] == '0') {
            bgn = '-'+disp_type_2;
        }
        else if (disp_type_2[0] != '-') {
            bgn = '+'+disp_type_2;
        }
        else {
            bgn = disp_type_2;
        }
        eq1.innerHTML = "$d = \\frac{"+disp1+" - ("+disp2+")}{"+disp_type_3+"} = "+display_form(strong_calc[0],false)+"$ <span style=\"margin-left:25px\"></span> $L = "+display_form(strong_calc[2],false)+"$ <span style=\"margin-left:25px\"></span> $U = "+display_form(strong_calc[3],false)+"$ <span style=\"margin-left:25px\"></span>(of loop index $"+type[1]+"$)";
        var dist_abs = '%';
        var comparable = false;
        var result = true;
        document.getElementById("partbutton_"+I).classList.add('parttab_button_red');
        var eq2 = document.createElement("div");
        eq2.style="margin-top:10px;";
        if (strong_calc[0][0].type == 'val' && strong_calc[1][0].type == 'val' && strong_calc[1].length == 1 && strong_calc[0].length == 1) {
            if (strong_calc[0][0].value < 0 ) {
                if (-strong_calc[0][0].value > strong_calc[1][0].value) {
                    result = false;
                }
            }
            else {
                if (strong_calc[0][0].value > strong_calc[1][0].value) {
                    result = false;
                }
            }
            comparable = true;
        }
        if (strong_calc[0][0].type == 'val') {
            if (strong_calc[0][0].value < 0) {
                dist_abs = true;
            }
            else {
                dist_abs = false;
            }
        }
        result_span = result ? "<span style=\" color:green; font-weight:700\">True</span>" : "<span style=\"color:red; font-weight:700\">False</span>";
        if (dist_abs != '%' && comparable == true ) {
            eq2.innerHTML += "$|d| \\lt U - L$ <span style=\"margin-left:10px\"></span> is <span style=\"margin-left:10px\"></span> $|"+strong_calc[0][0].value+"| \\le "+ display_form(strong_calc[3],false) + " " + display_form(get_form_mult(strong_calc[2],new Array(new Value(-1))),false)+"$ <span style=\"margin-left:10px\"></span> $\\equiv$ <span style=\"margin-left:10px\"></span> $"+(dist_abs ? (strong_calc[0][0].value *(-1)) : strong_calc[0][0].value)+" \\le "+display_form(strong_calc[1],false)+"$ <span style=\"margin-left:10px\"> "+ result_span ;
        }
        tab.appendChild(eq2);
        response = result ? 'Test <span style="font-weight:700; color:red;">does not</span> yield independence' : 'Test yields <span style="font-weight:700; color:green;">independence</span>';
        if (result == false) {
            document.getElementById("partbutton_"+I).classList.add('parttab_button_green');
            document.getElementById("partbutton_"+I).classList.remove('parttab_button_red');
        }
    }
    var last_step_1 = document.getElementById("calculate_div_"+I);
    var last_step_2 = document.getElementById("calculate_div_"+I+"_2");
    last_step_1.innerHTML = "<div class=\"continue_icon\">j</div> <span id=\"calculate_div_"+I+"_span\" class=\"cont_1_clicked\">Dependence:</span>";
    last_step_2.innerHTML = response;

    overall_dep();
    /////////////// if response cutarica
    /////////////// update thing after tabs
    //////////////// <3

    arrive_at("strong",document.getElementById("partbutton_"+I));

    MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
}

function overall_dep() {
    var red = false;
    var all_red = true;
    var orange = false;
    var green = false;
    var parttab;
    for (var i = 0; i < partitions.length; i ++) {
        parttab = document.getElementById("partbutton_"+i);

        if (parttab.classList.contains('parttab_button_red')) {
            red = true;
        }
        else {
            all_red = false;
        }
        if (parttab.classList.contains('parttab_button_orange')) {
            orange = true;
        }
        if (parttab.classList.contains('parttab_button_green')) {
            green = true;
        }
    }
    var part_status = document.getElementById("part_status");
    if (green == true) {
        part_status.innerHTML = "Tests yield independence";
        part_status.style= "display:inline-block; margin-left:10px; color: green";
    }
    else if (all_red == true) {
        part_status.innerHTML = 'Probably has dependence';
        part_status.style = "display:inline-block; margin-left:10px; color: red;";
    }
    else if (orange == true || red == true) {
        part_status.innerHTML = "Tests inconclusive";
        part_status.style = "display:inline-block; margin-left:10px; color: orange";
    }
    else {
        part_status.innerHTML = "Tests not done"
    }
}

// Subscript form

function Value(value) {
    this.type = 'val';
    this.value = value;
}

function Variable(variable) {
    this.type = 'var';
    this.variable = variable;
}

function get_form(expr) {
    if (expr.type == 'var') {
        var variable = new Variable(expr.variable);
        variable.elems = new Array();
        variable.elems.push(new Value(1));
        var arr = new Array();
        arr.push(variable);
        return arr;
    }
    else if (expr.type == 'val') {
        var arr = new Array();
        arr.push(new Value(expr.val));
        return arr;
    }
    else if (expr.type == 'op') {
        var arr = new Array();
        arr.push(new Value(-1));
        if (expr.lhs == null) {
            if (expr.op == '-') return get_form_mult(get_form(expr.rhs),arr);
            else return get_form(expr.rhs);
        }
        else {
            if (expr.op == '+') return get_form_add(get_form(expr.lhs),get_form(expr.rhs));
            else if (expr.op == '-') return get_form_add(get_form(expr.lhs),get_form_mult(get_form(expr.rhs),arr));
            else if (expr.op == '*') return get_form_mult(get_form(expr.lhs),get_form(expr.rhs));
            else if (expr.op == '/') return get_form_div(get_form(expr.lhs),get_form(expr.rhs));
        }
    }
    return "not supported";
}

/*
function F_Set(val) {
    this.vars = new Array();
    this.val = val;
}

function F_Var(variable) {
    this.coef_val = 1;
    this.coef_vars = new Array();
    this.variable = variable;
}*/

/*function get_form(expr) {
    if (expr.type == 'var') {
        var set = new F_Set(0);
        set.vars.push(new F_Var(expr.variable));
        return set;
    }
    if (expr.type == 'val') return new F_Set(expr.val);
    if (expr.type == 'op') {
        if (expr.lhs == null) {
            if (expr.op == '-') return get_form_mult(get_form(expr.rhs),new F_Set(-1));
        }
        else {
            if (expr.op == '+') return get_form_add(get_form(expr.lhs),get_form(expr.rhs));
            else if (expr.op == '-') return get_form_add(get_form(expr.lhs),get_form_mult(get_form(expr.rhs),new F_Set(-1)));
            else if (expr.op == '*') return get_form_mult(get_form(expr.lhs),get_form(expr.rhs));
        }
    }
}*/

function get_form_mult(x1,y1) {
    var x = jQuery.extend([], x1);
    var y = jQuery.extend([], y1);
    var i, j, ii, ok;
    var z = new Array();
    var k = new Map();
    for (i = 0; i < x.length; i ++) {
        for (j = 0; j < y.length; j ++) {
            if (k.has(i+","+j)) {
                if (j < y.length-1) j++;
                else break;
            }
            else {
                k.set(i+","+j,true);
                k.set(j+","+i,true);
            }
            if (x[i].type == 'var' && y[j].type == 'var') {
                if (x[i].variable == y[j].variable) { console.log('not supported'); return "not supported"; }
                else if (its.has(y[j].variable)) {
                    z.push(new Variable(y[j].variable));
                    var h = new Array();
                    h.push(x[i]);
                    z[z.length-1].elems = get_form_mult(y[j].elems,h);
                }
                else {
                    z.push(new Variable(x[i].variable));
                    var h = new Array();
                    h.push(y[i]);
                    z[z.length-1].elems = get_form_mult(x[i].elems,h);
                }
            }
            else {
                if (x[i].type == 'var') {
                    var h = new Array();
                    h.push(y[j]);
                    ok = 0;
                    for (ii = 0; ii < z.length; ii ++) {
                        if (z[ii].type == 'var') {
                            if (z[ii].variable == x[i].variable) {
                                z[ii].elems = get_form_add(z[ii].elems,get_form_mult(x[i].elems,h));
                                ok = 1;
                            }
                        }
                    }
                    if (ok == 0) {
                        z.push(x[i]);
                        z[z.length-1].elems = get_form_mult(x[i].elems,h);
                    }
                }
                else if (y[j].type == 'var') {
                    var h = new Array();
                    h.push(x[i]);
                    ok = 0;
                    for (ii = 0; ii < z.length; ii ++) {
                        if (z[ii].type == 'var') {
                            if (z[ii].variable == y[j].variable) {
                                z[ii].elems = get_form_add(z[ii].elems,get_form_mult(y[j].elems,h));
                                ok = 1;
                            }
                        }
                    }
                    if (ok == 0) {
                        z.push(y[j]);
                        z[z.length-1].elems = get_form_mult(y[j].elems,h);
                    }
                }
                else {
                    z.push(new Value(x[i].value*y[j].value));
                }
            }
        }
    }
    return z;
}

function get_form_div(x1,y1) {
    var x = jQuery.extend([], x1);
    var y = jQuery.extend([], y1);
    var i, j, ii, ok;
    var z = new Array();
    var k = new Map();
    for (i = 0; i < x.length; i ++) {
        for (j = 0; j < y.length; j ++) {
            if (k.has(i+","+j)) {
                if (j < y.length-1) j++;
                else break;
            }
            else {
                k.set(i+","+j,true);
                k.set(j+","+i,true);
            }
            if (x[i].type == 'var' && y[j].type == 'var') {
                if (x[i].variable == y[j].variable) {
                    if (x[i].elems.length == 1 && x[i].elems[0].type == 'val' && y[j].elems.length == 1 && y[j].elems[0].type == 'val') {
                        z.push(new Value(x[i].elems[0].value/y[j].elems[0].value));
                    }
                    else {
                        return "not supported";
                    }
                }
                else {
                    return "not supported";
                }
                /*else if (its.has(y[j].variable)) {
                    z.push(new Variable(y[j].variable));
                    var h = new Array();
                    h.push(x[i]);
                    z[z.length-1].elems = get_form_mult(y[j].elems,h);
                }
                else {
                    z.push(new Variable(x[i].variable));
                    var h = new Array();
                    h.push(y[i]);
                    z[z.length-1].elems = get_form_mult(x[i].elems,h);
                }*/
            }
            else {
                if (x[i].type == 'var') {
                    z.push(x[i]);
                    var h  = new Array();
                    h.push(y[j]);
                    z[z.length-1].elems = get_form_div(x[i].elems,h);
                }
                else if (y[j].type == 'var') {
                    z.push(x[i]);
                    if (x[i].value != 0) {
                        z[z.length-1].divided = y[j];
                    }
                }
                /*if (x[i].type == 'var') {
                    var h = new Array();
                    h.push(y[j]);
                    ok = 0;
                    for (ii = 0; ii < z.length; ii ++) {
                        if (z[ii].type == 'var') {
                            if (z[ii].variable == x[i].variable) {
                                z[ii].elems = get_form_add(z[ii].elems,get_form_mult(x[i].elems,h));
                                ok = 1;
                            }
                        }
                    }
                    if (ok == 0) {
                        z.push(x[i]);
                        z[z.length-1].elems = get_form_mult(x[i].elems,h);
                    }
                }*/
                /*else if (y[j].type == 'var') {
                    var h = new Array();
                    h.push(x[i]);
                    ok = 0;
                    for (ii = 0; ii < z.length; ii ++) {
                        if (z[ii].type == 'var') {
                            if (z[ii].variable == y[j].variable) {
                                z[ii].elems = get_form_add(z[ii].elems,get_form_mult(y[j].elems,h));
                                ok = 1;
                            }
                        }
                    }
                    if (ok == 0) {
                        z.push(y[j]);
                        z[z.length-1].elems = get_form_mult(y[j].elems,h);
                    }
                }*/
                else {
                    z.push(new Value(x[i].value/y[j].value));
                }
            }
        }
    }
    return z;
}

function get_form_add(x1,y1) {
    var x = jQuery.extend([], x1);
    var y = jQuery.extend([], y1);
    var i, j;
    var z = new Array();
    var w = new Array();
    for (j = 0 ; j < y.length; j ++) {
        z.push(0);
    }
    for (i = 0; i < x.length; i ++) {
        w.push(jQuery.extend({},x[i]));
        for (j = 0; j < y.length; j ++) {
            if (x[i].type == 'var' && y[j].type == 'var'){
                if (x[i].variable == y[j].variable) {
                    w[i].elems = get_form_add(x[i].elems,y[j].elems);
                    if (w[i].elems.length == 1) {
                        if (w[i].elems[0].type == 'val') {
                            if (w[i].elems[0].value == 0) {
                                w.pop();
                            }
                        }
                    }
                    z[j] = 1;
                }
            }
            else if (x[i].type == 'val' && y[j].type == 'val') {
                if (x[i].divided == y[j].divided) {
                    w[i].value = x[i].value + y[j].value;
                    z[j] = 1;
                }
            }
        }
    }
    for (j = 0; j < y.length; j ++) {
        if (z[j] == 0) {
            w.push(y[j]);
        }
    }
    if (w.length == 0) {
        w.push(new Value(0));
    }
    return w;
}

/*
function get_form_add(x,y) {
    var i, j;
    for (i = 0; i < x.vars.length; i ++) {
        for (j = 0; j < y.vars.length; j ++) {
            if (x.vars[i].variable == y.vars[j].variable) {
                x.vars[i].coef_val += y.vars[j].coef_val;
                //x.vars[i].coef_vars.push(y.vars[j].coef_vars);
                y.vars.splice(j,1);
            }
        }
    }
    for (j = 0; j < y.vars.length; j ++) {
        x.vars.push(y.vars[j]);
    }
    x.val += y.val;
    return x;
}

function get_form_mult(x,y) {
    var i, j;
    for (i = 0; i < x.vars.length; i++) {
        x.vars[i].coef_val *= y.val;
        for (j = 0; j < y.vars.length; j++) {
            if (x.vars[i].variable == y.vars[j].variable) {
                return "not_supported";
            }
            else if (its.has(x.vars[i].variable) && its.has(y.vars[j].variable)) {
                return "not_supported";
            }
            else if (its.has(x.vars[i].variable)) {
                x.vars[i].coef_val *= y.vars[j].coef_val;
                x.vars[i].coef_vars.push(y.vars[j].variable);
            }
            else if (its.has(y.vars[j].variable)) {
                x.vars[i].coef_val *= y.vars[j].coef_val;
                x.vars[i].coef_vars.push(x.vars[i].variable);
                x.vars[i].variable = y.vars[j].variable;
            }
            else {
                return "not_supported";
            }
        }
    }
    for (j = 0; j < y.vars.length; j++) {
        y.vars[j].coef_val *= x.val;
        if (y.vars[j].coef_val != 0 ) x.vars.push(y.vars[j]);
    }
    x.val *= y.val;
    return x;
}*/

function siv_form(forms) {
    if (forms.length >= 2) {
        var x = forms[0];
        var y = forms[1];
        return siv_equiv(x,y)
    }
    return null;
}

function banerjee(x,y) {
    var new_x = new Array(new Value(0));
    var new_y = new Array(new Value(0));
    var x_show = new Array();
    var y_show = new Array();
    var x_show2 = new Array();
    var y_show2 = new Array();
    var i, j, interm;
    for (i = 0; i < x.length; i ++) {
        if (x[i].type == 'var') {
            if (its.has(x[i].variable)) {
                range_brute = iterators_se.get(x[i].variable);

                if (range_brute[0].type == 'val') {
                    new_x = get_form_add(new_x,get_form_mult(new Array(new Value(range_brute[0].val)),x[i].elems));
                    interm = get_form_mult(new Array(new Value(range_brute[0].val)),x[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        x_show.push(interm[j]);
                    }
                }
                else {
                    new_x = get_form_add(new_x,get_form_mult(new Array(new Variable(range_brute[0].variable)),x[i].elems));
                    interm = get_form_mult(new Array(new Variable(range_brute[0].variable)),x[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        x_show.push(interm[j]);
                    }
                }
            }
            else {
                new_x = get_form_add(new_x,new Array(x[i]));
                x_show.push(x[i]);
            }
        }
        else {
            new_x = get_form_add(new_x,new Array(x[i]));
            x_show.push(x[i]);
        }
    }
    for (i = 0; i < y.length; i ++) {
        if (y[i].type == 'var') {
            if (its.has(y[i].variable)) {
                range_brute = iterators_se.get(y[i].variable);

                if (range_brute[1].type == 'val') {
                    new_y = get_form_add(new_y,get_form_mult(new Array(new Value(range_brute[1].val)),y[i].elems));
                    interm = get_form_mult(new Array(new Value(range_brute[1].val)),y[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        y_show.push(interm[j]);
                    }
                }
                else {
                    new_y = get_form_add(new_y,get_form_mult(new Array(new Variable(range_brute[1].variable)),y[i].elems));
                    interm = get_form_mult(new Array(new Variable(range_brute[1].variable)),y[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        y_show.push(interm[j]);
                    }
                }
            }
            else {
                new_y = get_form_add(new_y,new Array(y[i]));
                y_show.push(y[i]);
            }
        }
        else {
            new_y = get_form_add(new_y,new Array(y[i]));
            y_show.push(y[i]);
        }
    }
    var low = get_form_add(new_x,get_form_mult(new_y,new Array(new Value(-1))));
    new_y = get_form_mult(new_y,new Array(new Value(-1)));
    new_x = new Array(new Value(0));
    new_y = new Array(new Value(0));
    for (i = 0; i < x.length; i ++) {
        if (x[i].type == 'var') {
            if (its.has(x[i].variable)) {

                range_brute = iterators_se.get(x[i].variable);

                if (range_brute[1].type == 'val') {
                    new_x = get_form_add(new_x,get_form_mult(new Array(new Value(range_brute[1].val)),x[i].elems));
                    interm = get_form_mult(new Array(new Value(range_brute[1].val)),x[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        x_show2.push(interm[j]);
                    }
                }
                else {
                    new_x = get_form_add(new_x,get_form_mult(new Array(new Variable(range_brute[1].variable)),x[i].elems));
                    interm = get_form_mult(new Array(new Variable(range_brute[1].variable)),x[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        x_show2.push(interm[j]);
                    }
                }
            }
            else {
                new_x = get_form_add(new_x,new Array(x[i]));
                x_show2.push(x[i]);
            }
        }
        else {
            new_x = get_form_add(new_x,new Array(x[i]));
            x_show2.push(x[i]);
        }
    }
    for (i = 0; i < y.length; i ++) {
        if (y[i].type == 'var') {
            if (its.has(y[i].variable)) {

                range_brute = iterators_se.get(y[i].variable);

                if (range_brute[0].type == 'val') {
                    new_y = get_form_add(new_y,get_form_mult(new Array(new Value(range_brute[0].val)),y[i].elems));
                    interm = get_form_mult(new Array(new Value(range_brute[0].val)),y[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        y_show2.push(interm[j]);
                    }
                }
                else {
                    new_y = get_form_add(new_y,get_form_mult(new Array(new Variable(range_brute[0].variable)),y[i].elems));
                    interm = get_form_mult(new Array(new Variable(range_brute[0].variable)),y[i].elems);
                    for (j = 0 ; j < interm.length; j ++) {
                        y_show2.push(interm[j]);
                    }
                }
            }
            else {
                new_y = get_form_add(new_y,new Array(y[i]));
                y_show2.push(y[i]);
            }
        }
        else {
            new_y = get_form_add(new_y,new Array(y[i]));
            y_show2.push(y[i]);
        }
    }

    var high = get_form_add(new_x,get_form_mult(new_y,new Array(new Value(-1))));
    return [low,high,x_show,y_show,x_show2,y_show2];
}

function miv_test(x1,y1) {
    var x = jQuery.extend([], x1);
    var y = jQuery.extend([], y1);
    var index = [];
    var coeffs = [];
    var new_x = [];
    var new_y = [];
    var i;
    for (i = 0; i < x.length; i ++) {
        if (x[i].type == 'var') {
            if (its.has(x[i].variable)) {
                index.push(x[i].variable);
                coeffs.push(x[i].elems);
            }
            else {
                new_x.push(x[i]);
            }
        }
        else {
            new_x.push(x[i]);
        }
    }
    for (i = 0; i < y.length; i ++) {
        if (y[i].type == 'var') {
            if (its.has(y[i].variable)) {
                index.push(y[i].variable);
                coeffs.push(y[i].elems);
            }
            else {
                new_y.push(y[i]);
            }
        }
        else {
            new_y.push(y[i]);
        }
    }
    return [index,coeffs,new_x,new_y];
}

function miv_gcd(coeffs,new_x2,new_y2) {
    var new_x = jQuery.extend([], new_x2);
    var new_y = jQuery.extend([], new_y2);
    var i;
    for (i = 0; i < coeffs.length; i ++) {
        if (coeffs[i].length != 1) {
            return ['not_possible',i];
        }
        else {
            if (coeffs[i][0].type != 'val') {
                return ['not_possible',i];
            } 
        }
    }
    var result = gcd(coeffs[0][0].value,coeffs[1][0].value);

    if (coeffs.length > 2) {
        for (i = 2; i < coeffs.length; i++) {
            result = gcd(coeffs[i][0].value,result);
        }
    }
    if (new_y.length == 0) new_y.push(new Value(0));
    if (new_x.length == 0) new_x.push(new Value(0));
    divided = get_form_add(new_y,get_form_mult(new_x,new Array(new Value(-1))));

    if (divided.length == 1 && divided[0].type == 'val') {
        return ['possible',divided[0].value/result,divided,result];
    }
    else {
        return ['sort_of',get_form_div(divided,new Array(new Value(result))),divided,result];
    }


}

function siv_equiv(x1,y1) {
    var x = jQuery.extend([], x1);
    var y = jQuery.extend([], y1);
    var new_x = new Array(new Value(0));
    var new_y = new Array(new Value(0));
    var show_x = new Array();
    var show_y = new Array();
    var times_x = null;
    var times_y = null;
    for (i = 0; i < x.length; i ++) {
        if (x[i].type == 'var') {
            if (its.has(x[i].variable)) {
                times_x = x[i].elems;
                it = x[i].variable;
            }
            else {
                show_x.push(x[i]);
                new_x = get_form_add(new_x,new Array(x[i]));
            }
        }
        else {
            show_x.push(x[i]);
            new_x = get_form_add(new_x,new Array(x[i]));
        }
    }
    for (i = 0; i < y.length; i ++) {
        if (y[i].type == 'var') {
            if (its.has(y[i].variable)) {
                times_y = y[i].elems;
                it = y[i].variable;
            }
            else {
                show_y.push(y[i]);
                new_y = get_form_add(new_y,new Array(y[i]));
            }
        }
        else {
            show_y.push(y[i]);
            new_y = get_form_add(new_y,new Array(y[i]));
        }
    }
    if (times_x == null) {
        return ['weak-zero',it,0,times_y,show_x,show_y,new_x,new_y];
    }
    else if (times_y == null) {
        return ['weak-zero',it,times_x,0,show_x,show_y,new_x,new_y];
    }
    if (const_equiv(times_x,times_y)) {
        return ['strong',it,times_x,show_x,show_y,new_x,new_y];
    }
    var arr = new Array();
    arr.push(new Value(-1));
    if (const_equiv(times_x,get_form_mult(times_y,arr))) {
        return ['weak-crossing',it,times_x,times_y,show_x,show_y,new_x,new_y];
    }
    else {
        return ['weak',it,times_x,times_y,show_x,show_y,new_x,new_y];
    }
}

function strong_siv(f) {
    var it = f[1];
    var times = jQuery.extend([], f[2]);
    var x = jQuery.extend([], f[5])
    var y = jQuery.extend([], f[6])
    var arr = new Array();
    arr.push(new Value(-1));
    var dist = get_form_div(get_form_add(x,get_form_mult(y,arr)),times);
    var range_brute = iterators_se.get(it);
    var range = get_form_add(get_form(range_brute[1]),get_form_mult(get_form(range_brute[0]),arr));
    return [dist,range,get_form(range_brute[0]),get_form(range_brute[1])];
    // check if dist has variables if not take absolute value
    // need function to show -- still
}

function weak_crossing(it, a1x, c1x, c2x) {
    var a1 = jQuery.extend([], a1x);
    var c1 = jQuery.extend([], c1x);
    var c2 = jQuery.extend([], c2x);
    var arr = new Array();
    arr.push(new Value(-1));
    var i = get_form_div(get_form_add(c2,get_form_mult(c1,arr)),get_form_mult(a1,new Array(new Value(2))));
    var range_brute = iterators_se.get(it);
    var range = get_form_div(get_form_add(get_form(range_brute[1]),get_form(range_brute[0])),new Array(new Value(2)));
    return [i,range,get_form(range_brute[0]),get_form(range_brute[1])];
}

function display_form(f,b) {
    var string_build = "";
    if (f == null) { return "0"; }
    for (var i = 0; i < f.length; i ++) {
        if (f[i].type == 'val') {
            if (f[i].value < 0 ) string_build += f[i].value
            else string_build += '+' + f[i].value;
        }
        else if (f[i].type == 'var') {
            sb = display_form(f[i].elems,true);
            if (f[i].elems.length > 1) { string_build += '(' + sb + ')' + f[i].variable; }
            else if (sb == '-1') { string_build += '-' + f[i].variable; }
            else if (sb == '+1') { string_build += '+' + f[i].variable; }
            else { string_build += sb + f[i].variable; }
        }
    }
    if (b == false) {
        if (string_build[0] == '+') {
            string_build = string_build.substring(1,string_build.length);
        }
        if (string_build.length == 0) string_build = "0";
    }
    return string_build;
}



function const_equiv(x,y) {
    var i, j;
    for (i = 0; i < x.length; i ++) {
        match = false;
        for (j = 0; j < y.length; j ++) {
            if (x[i].type == 'val' && y[i].type == 'val'){
                if (x[i].value == y[i].value) match = true;
            }
            else if (x[i].type == 'var' && y[i].type == 'var'){
                if (x[i].variable == y[i].variable) {
                    if (const_equiv(x[i].elems,y[i].elems)) match = true;
                }
            }
        }
        if (!match) {
            return false;
        }
    }
    return true;
}




// Subscript end




// GCD Globals

function gcd (a, b) {
    if ( ! b) {
        return a;
    }

    return gcd(b, a % b);
}

function gcd_test(times1,times2,const12,const22) {
    const1 = jQuery.extend([], const12);
    const2 = jQuery.extend([], const22);
    var divider = null;
    var res = null;

    var arr = new Array();
    arr.push(new Value(-1));
    var divided = get_form_add(const2,get_form_mult(const1,arr));
    if (times1.length == 1 && times2.length == 1) {
        if (times1[0].type == 'val' && times2[0].type == 'val') {
            divider = gcd(times1[0].value,times2[0].value);
        }
        /*else if (times1[0].type == 'var' && times2[0].type == 'var') {
            if (times1[0].variable == times2[0].variable) {
                if (times1[0].elems.length == 1 && times2[0].elems.length == 1) {
                    if (times1[0].elems[0].type == 'val' && times2[0].elems[0].type == 'val') {
                        divider = gcd(times1[0].elems[0].value,times2[0].elems[0].value);
                    }
                }
            }
        }*/
    }
    if (divided.length == 1 && divider != null) {
        if (divided[0].type == 'val') {
            res = divided[0].value / divider;
        }
    }
    return [res,divided,divider];
}

/*function gcd_test(x,y) {
    var X;
    var Y;
    /*if (x.id != y.id) {
        document.getElementById("gcd_status").innerHTML = "The arrays of the calls do not match. There are is no dependency.";
    }
    else if (x.index_list.length != y.index_list.length) {
        document.getElementById("gcd_status").innerHTML = "The dimensions of the arrays called do not match !?";
    }* do this for array calss-------------------------------------------------------------------------------------------------------------8
    else {
        for (var i = 0; i < x.index_list.length; i ++) {
            X = gcd_extract(x.index_list[i]);
            Y = gcd_extract(y.index_list[i]);
            console.log(X+"..."+Y);
            var divider = gcd(X[1],Y[1]);
            var divided = Y[2]-X[2];
            console.log(divider,divided);
            var res = divided%divider;
            console.log(res);
            if (divider == 1) {
                document.getElementById("gcd_status").innerHTML = "GCD is 1 which divides everything.";
            }
            else {
                if (res == 0) {
                    document.getElementById("gcd_status").innerHTML = "The GCD is "+divider+", which divides "+divided+" => there is a dependency.";
                }
                else {
                    document.getElementById("gcd_status").innerHTML = "The GCD is "+divider+", which does not divide "+divided+" => there is no dependency.";
                }
            }
        }
    }
}*/

function gcd_extract(x) { // returns [x,2,-3] for A[2*x-3]
    var type = x.type;
    var op = x.op;
    var lhs = x.lhs;
    var rhs = x.rhs;

    if (type == 'val') {
        return [null,1,x.val];
    }
    else if (type == 'var') {
        return [x.variable,1,0];
    }
    else if (type == 'op')
    {   
        if (lhs == null) {
            var crhs = gcd_extract(rhs);
            if (op == '-') return [crhs[0],-crhs[1],-chrs[2]];
            else if (op == '+') return crhs;
        }
        else {
            var clhs = gcd_extract(lhs);
            var crhs = gcd_extract(rhs);
            if (clhs[0] == crhs[0]) {
                if (clhs[0] == null) {
                    if (op == '+') return [null,1,clhs[2]+crhs[2]];
                    else if (op == '-') return [null,1,clhs[2]-crhs[2]];
                    else if (op == '*') return [null,1,clhs[2]*crhs[2]];
                    else if (op == '/') return [null,1,clhs[2]/crhs[2]];
                }
                else {
                    if (op == '+') return [clhs[0],clhs[1]+crhs[1],clhs[2]+crhs[2]];
                    else if (op == '-') return [clhs[0],clhs[1]-crhs[2],clhs[2]-crhs[2]];
                }
            }
            else if (clhs[0] != null && crhs[0] == null) {
                if (op == '+') return [clhs[0],clhs[1],clhs[2]+crhs[2]];
                else if (op == '-') return [clhs[0],clhs[1],clhs[2]-crhs[2]];
                else if (op == '*') return [clhs[0],clhs[1]*crhs[2],clhs[2]*crhs[2]];
                else if (op == '/') return [clhs[0],clhs[1]/crhs[2],clhs[2]/crhs[2]];
            }
            else if (clhs[0] == null && crhs[0] != null) {
                if (op == '+') return [crhs[0],crhs[1],clhs[2]+crhs[2]];
                else if (op == '-') return [crhs[0],-crhs[1],clhs[2]-crhs[2]];
                else if (op == '*') return [crhs[0],clhs[2]*crhs[1],clhs[2]*crhs[2]];
            }
        }
    }
}

function run_active() {
    var i, j, tabcontent;

    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        if (tabcontent[i].style.display == "block") {
            if (i == 0) {
                var arr = writes_selected.entriesArray();
                for (j = 0; j < arr.length; j++) {
                    document.getElementById("vwrite_"+arr[j][0]).click();
                }
                arr = reads_selected.entriesArray();
                for (j = 0; j < arr.length; j++) {
                    document.getElementById("vread_"+arr[j][0]).click();
                }
                make_iteration_space();
                selection_mode = false;
            }
            else if (i == 1) {
                var arr = writes_selected.entriesArray();
                for (j = 0; j < arr.length; j++) {
                    document.getElementById("vwrite_"+arr[j][0]).click();
                }
                arr = reads_selected.entriesArray();
                for (j = 0; j < arr.length; j++) {
                    document.getElementById("vread_"+arr[j][0]).click();
                }
                make_dependency_graph();
                selection_mode = false;
                wrs = new Map();
            }
            else if (i == 2) {
                selection_mode = true;
            }
        }
    }
    change = false;
}

document.getElementById("run_button").addEventListener('click', function(event) {
    run_active();
});

/*document.getElementById("gcd_button").addEventListener('click', function(event) {
    var x;
    var y;
    if (wrs.length != 2) {
        document.getElementById("sub_status").innerHTML = "Have two calls selected to run the GCD Test.";
    }
    else {
        var x_type = wrs.get(1).substring(0,1);
        var y_type = wrs.get(2).substring(0,1);
        if (x_type == 'r' && y_type == 'r') {
            document.getElementById("gcd_status").innerHTML = "The selected calls are both reads. There cannot be a dependency between 2 reads.";
        }
        else {
            var x_no = parseInt(wrs.get(1).substring(1,wrs.get(1).length));
            var y_no = parseInt(wrs.get(2).substring(1,wrs.get(2).length));
            if (x_type == 'w') x = writes_enum.get(x_no);
            else if (x_type == 'r') x = reads_enum.get(x_no);
            if (y_type == 'w') y = writes_enum.get(y_no);
            else if (y_type == 'r') y = reads_enum.get(y_no);
            gcd_test(x,y);
        }
    }
});*/

document.getElementById('arrs').innerHTML = "...";
document.getElementById('subscripts').innerHTML = "...";
document.getElementById('partitions').innerHTML = "...";

$('#run_button').qtip({
    content: {
        text: 'Runs the type of analysis selected on the right hand side'
    },
    style: { classes: 'qtip-bootstrap' },
    position: {
        adjust: { x: 5, y: 5 }
    }
});
$('#toggle_thing').qtip({
    content: {
        text: 'Toggle on/off: runs whenever there is a change in the selection of statements/writes/reads. <br><br>Consider turning off when writing programs with more than 2 nested loops'
    },
    style: { classes: 'qtip-bootstrap' },
    position: {
        adjust: { x: 5, y: 5 }
    }
});

$(document).ready(function()
 {
     $('#question_vis').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tooltip_vis')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 }
            }
         });
     });
     $('#vis_subscr').each(function() {
         $(this).qtip({
             content: {
                 text: '<div><p>The term subscript will be used to refer to one of the subscripted positions in a pair of array references.</p><p>Since dependence tests always consider a pair of array references, we will always use the term subscript to refer to a pair of subscript positions. </p><p>For example, in the pair of references to array A in the following loop nest,</div><div style="font-family:\'Courier New\', Courier, monospace;"><div style="margin-left:10px; margin-top:10px;">DO i</div><div style="margin-left:20px;">    DO j</div><div style="margin-left:30px;">     DO k</div><div style="margin-left:40px;">      A(i, j) = A(i, k) + C</div><div style="margin-left:30px;">       ENDDO</div><div style="margin-left:20px;">  ENDDO</div><div style="margin-left:10px; margin-bottom:10px;">ENDDO</div></div><div>index i occurs in the first subscript and indexes j and k occur in the second subscript.</p></div>'
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 }
            }
         });
     });
     $('#vis_select').each(function() {
         $(this).qtip({
             content: {
                 text: 'For the purpose of these subscript tests, select either <ul><li> <span style="font-weight: 700; color:blue">2 writes</span>  (either which can potentially write to both)</li><li><span style="font-weight: 700; color:blue">1 write</span> (which can write after read or itself) and <span style="font-weight: 700; color:red">1 read</span> (which can read after write)</li></ul> Reads alone cannot cause dependence, and analyzing more than 2 subscripts is not possible.'
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 }
            }
         });
     });
     $('#vis_part').each(function() {
         $(this).qtip({
             content: {
                 text: '<div><p>Separability describes whether a given subscript interacts with other subscripts for the purpose of dependence testing. </p><p>When testing multidimensional arrays, a subscript position is said to be separable if its indexes do not occur in the other subscripts.</p> <p>If two different subscripts contain the same index, they are coupled. For example, in the loop below,</div><div style="font-family:\'Courier New\', Courier, monospace;"><div style="margin-left:10px; margin-top:10px;">DO i</div><div style="margin-left:20px;">    DO j</div><div style="margin-left:30px;">        DO k</div><div style="margin-left:40px;">            A(i, j, j) = A(i, j, k) + C</div><div style="margin-left:30px;">        ENDDO</div><div style="margin-left:20px;">    ENDDO</div><div style="margin-left:10px; margin-bottom:10px;">ENDDO</div></div><div>the first subscript is separable, but the second and third are coupled because they both contain j.</p><p>Partitition the subscripts corresponding to the array calls based on their separability.</p></div>'
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             adjust: { x: 5, y: 5 }
            }
         });
     });
 });

 /*$(document).ready(function()
 {
     $('#vis_select').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tool_select')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             target: 'mouse', // Track the mouse as the positioning target
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
 });*/

 /*$(document).ready(function()
 {
     $('.vis_subscr').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tool_subscr')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             target: 'mouse', // Track the mouse as the positioning target
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
 });

 $(document).ready(function()
 {
     $('.vis_part').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tool_part')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             target: 'mouse', // Track the mouse as the positioning target
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
 });

 $(document).ready(function()
 {
     $('.vis_ziv').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tool_ziv')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             target: 'mouse', // Track the mouse as the positioning target
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
 });

 $(document).ready(function()
 {
     $('.vis_siv').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tool_siv')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             target: 'mouse', // Track the mouse as the positioning target
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
 });

 $(document).ready(function()
 {
     $('.vis_miv').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tool_miv')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             target: 'mouse', // Track the mouse as the positioning target
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
 });

 $(document).ready(function()
 {
     $('.vis_coupled').each(function() {
         $(this).qtip({
             content: {
                 text: $(this).next('#tool_coupled')
             },
             style: { classes: 'qtip-bootstrap' },
             position: {
             target: 'mouse', // Track the mouse as the positioning target
             adjust: { x: 5, y: 5 } // Offset it slightly from under the mouse
            }
         });
     });
 });*/

 var idle = 0;

function timer_increment() {
    idle++;
}

function timer() {
    var active = 'none';
    if (idle <= 2 && !document.hidden) {
        if (parsed == false) {
            active = "none";
        }
        else if (document.getElementById('IterationSpace').style.display != 'none') {
            active = "iteration_space";
        }
        else if (document.getElementById('DependencyGraph').style.display != 'none') {
            active = "dependency_graph";
        }
        else {
            active = "subscript_tests";
        }
        /*$.ajax({
            url: 'timer.php',
            type: "POST",
            dataType: 'json',
            data: ({
                user: handle,
                active: active
            })
        });*/
    }

    setTimeout(timer, 30000);
}

function put_info(what) {
    /*$.ajax({
        url: 'put_info.php',
        type: "POST",
        dataType: 'json',
        data: ({
            user: handle,
            what: what
        })
    });*/
}

function arrive_at(what,elem) {
    if (handle != 'phlnx') {
        var indep = 0;
        if (elem.classList.contains('parttab_button_green')) {
            indep = 1;
        }
        /*$.ajax({
            url: 'arrive_at.php',
            type: "POST",
            dataType: 'json',
            data: ({
                user: handle,
                what: what,
                indep: indep
            })
        }); */
    }  
}

window.onerror = function (msg, url, lineNo, columnNo, error) {
  add_to_console('Parsing ERROR: Visualisation might be wrong','orange');

  return false;
}


document.getElementById('itspc_button').click();
/*$( document ).ready(function() {
    handle = prompt("Please use Chrome. Enter your handle (if you do not have one, ask to participate at laurentiu.avasiloaie@gmail.com): ", "your handle here");
    if (handle == null) handle = 'unknown';
    handle = handle.toLowerCase();
    timer();
    var idle_interval = setInterval(timer_increment, 29000);
    $(this).mousemove(function (e) {
        idle = 0;
    });
    $(this).keypress(function (e) {
        idle = 0;
    });
});*/
  </script>
  </body>
  
</html>